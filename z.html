<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" href="https://raw.githubusercontent.com/ghostm68/inktwo/main/Images/favicon.ico" />
    <title>2471 | Z.AI AIR TERMINAL</title>
    <style>
        :root {
            --bg: #0a0a0a; --panel: #111; --border: #333; --red: #ff4444; --text: #eee;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Georgia', serif; margin: 0; padding: 1rem; }
        .container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; max-width: 1800px; margin: 0 auto; height: 90vh; }
        .panel { background: var(--panel); border: 1px solid var(--border); padding: 1rem; display: flex; flex-direction: column; }
        h2 { color: var(--red); font-size: 0.8rem; text-transform: uppercase; border-bottom: 1px solid var(--border); padding-bottom: 5px; margin-top: 0; }
        
        textarea, input, select { 
            background: #000; color: #fff; border: 1px solid var(--border); padding: 8px; margin-bottom: 10px; font-family: inherit;
        }
        
        /* THE 2471 RED SLIDER */
        input[type="range"] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type="range"]::-webkit-slider-runnable-track { width: 100%; height: 2px; background: var(--red); }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 15px; width: 15px; background: var(--red); margin-top: -6px; cursor: pointer; }

        button { 
            background: transparent; color: #fff; border: 1px solid var(--red); padding: 10px; cursor: pointer; text-transform: uppercase; font-size: 0.7rem; 
        }
        button:hover { background: var(--red); color: #000; }
        
        #output { flex: 1; overflow-y: auto; white-space: pre-wrap; font-size: 0.95rem; line-height: 1.6; padding: 10px; background: #050505; border: 1px solid #222; }
        #notepad { flex: 1; resize: none; background: #050505; color: #ccc; }
        
        .toggle-group { display: flex; align-items: center; gap: 10px; font-size: 0.7rem; color: #888; margin-bottom: 10px; }
    </style>
    <style>
    /* 2471 Industrial Pulse */
    .neural-load-container {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: #000;
        border-top: 1px solid #222;
        margin-top: auto;
    }

    .load-label {
        font-size: 0.6rem;
        color: #444;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .kali-bars {
        display: flex;
        align-items: flex-end;
        gap: 2px;
        height: 20px;
    }

    .kali-bar {
        width: 4px;
        height: 30%;
        background: #222; /* Start as Cold Grey */
        /* The "Segmented" Kali look */
        background-image: linear-gradient(to bottom, rgba(0,0,0,0.5) 1px, transparent 1px);
        background-size: 100% 3px;
        transition: all 0.1s ease;
    }

    /* The "Ignition" state */
    .active-engine .kali-bar {
        background-color: #ff4444; /* High-Alert Red */
        box-shadow: 0 0 5px rgba(255, 68, 68, 0.2);
    }
</style>
</head>
<body>

<div class="container">
    <!-- LEFT: ARCHIVE -->
    <div class="panel">
        <h2>Archive / Notepad</h2>
        <textarea id="notepad" placeholder="Your story archive..."></textarea>
        <button id="exportBtn" style="margin-top:10px">Export .txt</button>
    </div>

    <!-- MIDDLE: CONTROL -->
    <div class="panel">
        <h2>Command Console</h2>
        <label style="font-size: 0.6rem;">Z.AI API KEY</label>
        <input type="password" id="apiKey" placeholder="z.ai-..." />
        
<label style="font-size: 0.6rem;">MODEL SELECT</label>
<select id="modelId">
    <option value="glm-4-flash">GLM-4-Flash (Free/Stable)</option>
    <option value="glm-4-air">GLM-4-Air (Industrial Fast)</option>
    <option value="glm-4-plus">GLM-4-Plus (Premium/Frontier)</option>
</select>

        <div class="toggle-group">
            <input type="checkbox" id="thinkingMode" checked> 
            <label for="thinkingMode">ENABLE THINKING (CoT)</label>
        </div>

        <label style="font-size: 0.6rem;">NARRATIVE PROMPT</label>
        <textarea id="prompt" style="height: 150px;" placeholder="Describe the scene..."></textarea>
        
        <label style="font-size: 0.6rem;">ENTROPY: <span id="tempVal">0.7</span></label>
        <input type="range" id="temp" min="0" max="1" step="0.1" value="0.7">
        
        <button id="execBtn" style="font-weight: bold; font-size: 1rem; margin-top: 10px;">Execute</button>
    </div>

    <!-- RIGHT: OUTPUT -->
    <div class="panel">
        <h2>System Output (Streaming)</h2>
        <div id="output">Terminal Ready...</div>
        <button id="transferBtn" style="margin-top:10px" disabled>Transfer to Archive</button>
    </div>
</div>

<div class="neural-load-container" id="engineStatus">
    <div class="load-label">Neural Engine</div>
    <div class="kali-bars" id="pulseGrid">
        <!-- 12-15 bars look best -->
    </div>
</div>
<script>
document.getElementById('execBtn').onclick = async () => {
    const btn = document.getElementById('execBtn');
    const out = document.getElementById('output');
    const key = document.getElementById('apiKey').value;
    const prompt = document.getElementById('prompt').value;
    
    // THIS IS THE KEY: 'glm-4-flash' is usually the only one with a free balance
    const model = "glm-4-flash"; 

    if(!key) return alert("API Key Required");

    out.innerHTML = "SYSTEM: ESTABLISHING FREE-TIER LINK...";
    btn.disabled = true;

    try {
        const response = await fetch("https://corsproxy.io/?https://api.z.ai/api/paas/v4/chat/completions", {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${key}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                model: model,
                messages: [
                    { role: "user", content: prompt }
                ],
                // Matching their Java SDK parameters exactly:
                thinking: { type: "enabled" },
                max_tokens: 4096,
                temperature: 0.6,
                stream: true 
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            // If this says "No Balance", it means even the Flash model needs a top-up
            throw new Error(errorData.error.message || "Connection Failed");
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullStory = "";
        out.innerHTML = ""; 

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split("\n");

            for (const line of lines) {
                if (line.trim().startsWith("data: ")) {
                    const dataStr = line.trim().slice(6);
                    if (dataStr === "[DONE]") break;

                    try {
                        const json = JSON.parse(dataStr);
                        // Catching content from the 'delta' object as per their SDK
                        const content = json.choices[0].delta.content || "";
                        const reasoning = json.choices[0].delta.reasoning_content || "";

                        if (reasoning) {
                            out.innerHTML = `<div style="color:#555; font-size:0.8rem;">[THINKING]: ${reasoning}</div>` + fullStory;
                        }
                        if (content) {
                            fullStory += content;
                            out.innerHTML = (out.innerHTML.includes("[THINKING]") ? out.innerHTML.split("</div>")[0] + "</div>" : "") + 
                                            `<div style="color:#eee;">${fullStory}</div>`;
                        }
                        out.scrollTop = out.scrollHeight;
                    } catch (e) {}
                }
            }
        }
    } catch (err) {
        out.innerHTML = `<span style="color:red">TERMINAL ERROR: ${err.message}</span>`;
    } finally {
        btn.disabled = false;
        btn.textContent = "Execute Generation";
    }
};
</script>
<script>
    const pulseGrid = document.getElementById('pulseGrid');
    const engineStatus = document.getElementById('engineStatus');
    
    // Create the bars
    for(let i=0; i<15; i++) {
        const b = document.createElement('div');
        b.className = 'kali-bar';
        pulseGrid.appendChild(b);
    }

    function animateEngine(intensity) {
        const bars = document.querySelectorAll('.kali-bar');
        bars.forEach(bar => {
            const h = Math.random() * intensity + 20;
            bar.style.height = h + '%';
        });
    }

    // Logic to bridge with your Z.ai "Execute" function
    // 1. When Generate starts: engineStatus.classList.add('active-engine');
    // 2. Set intensity to 80.
    // 3. When done: engineStatus.classList.remove('active-engine');
    // 4. Set intensity back to 10.
    
    let currentIntensity = 15;
    setInterval(() => animateEngine(currentIntensity), 100);
</script>
</body>
</html>
