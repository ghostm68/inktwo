<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" href="https://raw.githubusercontent.com/ghostm68/inktwo/main/Images/favicon.ico" />
    <title>2471 | OPENROUTER TERMINAL</title>
    <style>
        :root { --bg: #0a0a0a; --panel: #121212; --border: #222; --red: #ff4444; --text: #eee; }
        body { background: var(--bg); color: var(--text); font-family: 'Georgia', serif; margin: 0; padding: 1rem; overflow: hidden; }
        .container { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 1rem; max-width: 1800px; margin: 0 auto; height: calc(100vh - 80px); }
        .panel { background: var(--panel); border: 1px solid var(--border); padding: 1.2rem; display: flex; flex-direction: column; position: relative; }
        h2 { color: var(--red); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-top: 0; }
        textarea, input, select { background: #000; color: #fff; border: 1px solid var(--border); padding: 10px; margin-bottom: 1rem; font-family: 'Courier New', monospace; font-size: 0.85rem; }
        input[type="range"] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type="range"]::-webkit-slider-runnable-track { width: 100%; height: 2px; background: var(--red); }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; background: var(--red); margin-top: -7px; cursor: pointer; }
        button { background: transparent; color: #fff; border: 1px solid var(--red); padding: 12px; cursor: pointer; text-transform: uppercase; font-size: 0.7rem; transition: 0.2s; }
        button:hover { background: var(--red); color: #000; font-weight: bold; }
        #output-area { flex: 1; background: #050505; padding: 15px; border: 1px solid #1a1a1a; overflow-y: auto; font-size: 0.95rem; line-height: 1.7; white-space: pre-wrap; }
        #notepad { flex: 1; background: #050505; border: 1px solid #1a1a1a; resize: none; color: #aaa; }
        .kali-container { display: flex; align-items: flex-end; gap: 2px; height: 30px; margin-top: 10px; padding: 5px; background: #000; }
        .kali-bar { width: 5px; background: #222; background-image: linear-gradient(to bottom, rgba(0,0,0,0.5) 1px, transparent 1px); background-size: 100% 3px; transition: height 0.1s ease; }
        .active-engine .kali-bar { background-color: var(--red); }
    </style>
</head>
<body>

    <div style="text-align: center; margin-bottom: 10px;">
        <h1 style="margin:0; font-size: 1.2rem; letter-spacing: 5px; color: var(--text);">PROTOCOL 2471</h1>
    </div>

    <div class="container">
        <div class="panel">
            <h2>Archive / Notepad</h2>
            <textarea id="notepad" placeholder="Storage for generated artifacts..."></textarea>
            <button id="exportBtn" style="margin-top:10px;">Export TXT</button>
        </div>

        <div class="panel">
            <h2>OpenRouter Console</h2>
            <label style="font-size: 0.6rem; color: #666;">OPENROUTER API KEY</label>
            <input type="password" id="apiKey" placeholder="sk-or-...">
            
            <label style="font-size: 0.6rem; color: #666;">ACTIVE MODEL</label>
            <input type="text" id="modelId" value="z-ai/glm-4.5-air:free" readonly style="color:var(--red); border-color:var(--red)">

            <label style="font-size: 0.6rem; color: #666;">NARRATIVE PARAMETERS</label>
            <textarea id="prompt" style="height: 120px;" placeholder="Input story seed..."></textarea>

            <label style="font-size: 0.6rem; color: #666;">ENTROPY: <span id="tempDisp">0.7</span></label>
            <input type="range" id="temp" min="0" max="1" step="0.1" value="0.7">

            <button id="execBtn" style="margin-top: 10px; font-size: 0.9rem;">Execute Generation</button>
        </div>

        <div class="panel" id="outputPanel">
            <h2>System Output</h2>
            <div id="output-area">Terminal Standby...</div>
            <div class="kali-container" id="kaliGrid"></div>
            <button id="transferBtn" style="margin-top:10px;" disabled>âž” Transfer to Archive</button>
        </div>
    </div>

    <script>
        const tempInput = document.getElementById('temp');
        tempInput.oninput = () => document.getElementById('tempDisp').innerText = tempInput.value;

        const savedKey = localStorage.getItem('2471_or_key');
        if(savedKey) document.getElementById('apiKey').value = savedKey;

        for(let i=0; i<30; i++) {
            const bar = document.createElement('div');
            bar.className = 'kali-bar';
            document.getElementById('kaliGrid').appendChild(bar);
        }

        let engineActive = false;
        setInterval(() => {
            const bars = document.querySelectorAll('.kali-bar');
            bars.forEach(bar => {
                const h = engineActive ? (Math.random() * 80 + 20) : (Math.random() * 10 + 5);
                bar.style.height = h + '%';
            });
        }, 100);

        document.getElementById('execBtn').onclick = async () => {
            const btn = document.getElementById('execBtn');
            const out = document.getElementById('output-area');
            const key = document.getElementById('apiKey').value.trim();
            const prompt = document.getElementById('prompt').value.trim();

            if(!key || !prompt) return alert("Credentials Missing.");
            localStorage.setItem('2471_or_key', key);

            btn.disabled = true;
            btn.textContent = "Routing...";
            out.innerHTML = "<span style='color:#444'>Handshaking with OpenRouter...</span>";
            engineActive = true;
            document.getElementById('outputPanel').classList.add('active-engine');

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${key}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": "https://inkrealm.info",
                        "X-Title": "2471 Terminal"
                    },
                    body: JSON.stringify({
                        model: "z-ai/glm-4.5-air:free",
                        messages: [{ role: "user", content: prompt }],
                        stream: true,
                        temperature: parseFloat(tempInput.value)
                    })
                });

                if (!response.ok) throw new Error(await response.text());

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullText = "";
                out.innerHTML = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split("\n");
                    for (const line of lines) {
                        if (line.trim().startsWith("data: ")) {
                            const dataStr = line.trim().slice(6);
                            if (dataStr === "[DONE]") break;
                            try {
                                const json = JSON.parse(dataStr);
                                const content = json.choices[0].delta.content || "";
                                if (content) {
                                    fullText += content;
                                    out.innerText = fullText;
                                    out.scrollTop = out.scrollHeight;
                                }
                            } catch (e) {}
                        }
                    }
                }
                document.getElementById('transferBtn').disabled = false;
            } catch (err) {
                out.innerHTML = `<span style="color:var(--red)">ROUTING FAILURE: ${err.message}</span>`;
            } finally {
                btn.disabled = false;
                btn.textContent = "Execute Generation";
                engineActive = false;
                document.getElementById('outputPanel').classList.remove('active-engine');
            }
        };

        document.getElementById('transferBtn').onclick = () => {
            document.getElementById('notepad').value += "\n\n--- INCOMING TRANSMISSION ---\n" + document.getElementById('output-area').innerText;
        };
    </script>
</body>
</html>
