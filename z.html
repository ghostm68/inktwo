<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" href="https://raw.githubusercontent.com/ghostm68/inktwo/main/Images/favicon.ico" />
    <title>2471 | Z.AI AIR TERMINAL</title>
    <style>
        :root {
            --bg: #0a0a0a; --panel: #111; --border: #333; --red: #ff4444; --text: #eee;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Georgia', serif; margin: 0; padding: 1rem; }
        .container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; max-width: 1800px; margin: 0 auto; height: 90vh; }
        .panel { background: var(--panel); border: 1px solid var(--border); padding: 1rem; display: flex; flex-direction: column; }
        h2 { color: var(--red); font-size: 0.8rem; text-transform: uppercase; border-bottom: 1px solid var(--border); padding-bottom: 5px; margin-top: 0; }
        
        textarea, input, select { 
            background: #000; color: #fff; border: 1px solid var(--border); padding: 8px; margin-bottom: 10px; font-family: inherit;
        }
        
        /* THE 2471 RED SLIDER */
        input[type="range"] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type="range"]::-webkit-slider-runnable-track { width: 100%; height: 2px; background: var(--red); }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 15px; width: 15px; background: var(--red); margin-top: -6px; cursor: pointer; }

        button { 
            background: transparent; color: #fff; border: 1px solid var(--red); padding: 10px; cursor: pointer; text-transform: uppercase; font-size: 0.7rem; 
        }
        button:hover { background: var(--red); color: #000; }
        
        #output { flex: 1; overflow-y: auto; white-space: pre-wrap; font-size: 0.95rem; line-height: 1.6; padding: 10px; background: #050505; border: 1px solid #222; }
        #notepad { flex: 1; resize: none; background: #050505; color: #ccc; }
        
        .toggle-group { display: flex; align-items: center; gap: 10px; font-size: 0.7rem; color: #888; margin-bottom: 10px; }
    </style>
    <style>
    /* 2471 Industrial Pulse */
    .neural-load-container {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: #000;
        border-top: 1px solid #222;
        margin-top: auto;
    }

    .load-label {
        font-size: 0.6rem;
        color: #444;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .kali-bars {
        display: flex;
        align-items: flex-end;
        gap: 2px;
        height: 20px;
    }

    .kali-bar {
        width: 4px;
        height: 30%;
        background: #222; /* Start as Cold Grey */
        /* The "Segmented" Kali look */
        background-image: linear-gradient(to bottom, rgba(0,0,0,0.5) 1px, transparent 1px);
        background-size: 100% 3px;
        transition: all 0.1s ease;
    }

    /* The "Ignition" state */
    .active-engine .kali-bar {
        background-color: #ff4444; /* High-Alert Red */
        box-shadow: 0 0 5px rgba(255, 68, 68, 0.2);
    }
</style>
</head>
<body>

<div class="container">
    <!-- LEFT: ARCHIVE -->
    <div class="panel">
        <h2>Archive / Notepad</h2>
        <textarea id="notepad" placeholder="Your story archive..."></textarea>
        <button id="exportBtn" style="margin-top:10px">Export .txt</button>
    </div>

    <!-- MIDDLE: CONTROL -->
    <div class="panel">
        <h2>Command Console</h2>
        <label style="font-size: 0.6rem;">Z.AI API KEY</label>
        <input type="password" id="apiKey" placeholder="z.ai-..." />
        
        <label style="font-size: 0.6rem;">MODEL SELECT</label>
        <select id="modelId">
            <option value="glm-4-air">GLM-4-Air (Fast/Creative)</option>
            <option value="glm-4.5">GLM-4.5 (Flagship)</option>
            <option value="glm-4-flash">GLM-4-Flash (Free/Lite)</option>
        </select>

        <div class="toggle-group">
            <input type="checkbox" id="thinkingMode" checked> 
            <label for="thinkingMode">ENABLE THINKING (CoT)</label>
        </div>

        <label style="font-size: 0.6rem;">NARRATIVE PROMPT</label>
        <textarea id="prompt" style="height: 150px;" placeholder="Describe the scene..."></textarea>
        
        <label style="font-size: 0.6rem;">ENTROPY: <span id="tempVal">0.7</span></label>
        <input type="range" id="temp" min="0" max="1" step="0.1" value="0.7">
        
        <button id="execBtn" style="font-weight: bold; font-size: 1rem; margin-top: 10px;">Execute</button>
    </div>

    <!-- RIGHT: OUTPUT -->
    <div class="panel">
        <h2>System Output (Streaming)</h2>
        <div id="output">Terminal Ready...</div>
        <button id="transferBtn" style="margin-top:10px" disabled>Transfer to Archive</button>
    </div>
</div>

<div class="neural-load-container" id="engineStatus">
    <div class="load-label">Neural Engine</div>
    <div class="kali-bars" id="pulseGrid">
        <!-- 12-15 bars look best -->
    </div>
</div>

<script>
    const tempInput = document.getElementById('temp');
    tempInput.oninput = () => document.getElementById('tempVal').innerText = tempInput.value;

    const savedKey = localStorage.getItem('zai_2471_key');
    if(savedKey) document.getElementById('apiKey').value = savedKey;

    document.getElementById('execBtn').onclick = async () => {
        const btn = document.getElementById('execBtn');
        const out = document.getElementById('output');
        const key = document.getElementById('apiKey').value;
        const prompt = document.getElementById('prompt').value;
        const model = document.getElementById('modelId').value;
        const thinkingEnabled = document.getElementById('thinkingMode').checked;
        
        if(!key) return alert("Missing API Key");
        localStorage.setItem('zai_2471_key', key);

        out.innerHTML = "Establishing Link...";
        btn.disabled = true;
        btn.textContent = "Processing...";

        try {
            // Using an alternative proxy method that handles streams better
            const apiUrl = "https://api.z.ai/api/paas/v4/chat/completions";
            const proxyUrl = "https://corsproxy.io/?" + encodeURIComponent(apiUrl);

            const response = await fetch(proxyUrl, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${key}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: model,
                    messages: [{ role: "user", content: prompt }],
                    temperature: parseFloat(tempInput.value),
                    // Only send thinking if enabled; some models error if it's sent as 'false'
                    ...(thinkingEnabled && { thinking: { type: "enabled" } }),
                    stream: true 
                })
            });

            if (!response.ok) {
                const errData = await response.text();
                throw new Error(`API Error ${response.status}: ${errData}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullText = "";
            out.innerHTML = ""; // Clear for real output

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value, { stream: true });
                // Z.ai chunks are separated by "data: "
                const lines = chunk.split("\n");
                
                for (const line of lines) {
                    const trimmed = line.trim();
                    if (!trimmed || trimmed === "data: [DONE]") continue;
                    
                    if (trimmed.startsWith("data: ")) {
                        try {
                            const json = JSON.parse(trimmed.slice(6));
                            const delta = json.choices[0].delta;
                            
                            // Catch standard content OR reasoning/thinking content
                            const newBits = delta.content || delta.reasoning_content || "";
                            
                            if (newBits) {
                                fullText += newBits;
                                out.innerText = fullText;
                                out.scrollTop = out.scrollHeight;
                            }
                        } catch (e) {
                            console.log("Chunk parse error", e);
                        }
                    }
                }
            }
            document.getElementById('transferBtn').disabled = false;
        } catch (err) {
            console.error(err);
            out.innerHTML = `<span style="color:var(--red)">SYSTEM ERROR: ${err.message}</span>`;
        } finally {
            btn.disabled = false;
            btn.textContent = "Execute Generation";
        }
    };

    document.getElementById('transferBtn').onclick = () => {
        const note = document.getElementById('notepad');
        note.value += (note.value ? "\n\n" : "") + document.getElementById('output').innerText;
    };
</script>


<script>
    const pulseGrid = document.getElementById('pulseGrid');
    const engineStatus = document.getElementById('engineStatus');
    
    // Create the bars
    for(let i=0; i<15; i++) {
        const b = document.createElement('div');
        b.className = 'kali-bar';
        pulseGrid.appendChild(b);
    }

    function animateEngine(intensity) {
        const bars = document.querySelectorAll('.kali-bar');
        bars.forEach(bar => {
            const h = Math.random() * intensity + 20;
            bar.style.height = h + '%';
        });
    }

    // Logic to bridge with your Z.ai "Execute" function
    // 1. When Generate starts: engineStatus.classList.add('active-engine');
    // 2. Set intensity to 80.
    // 3. When done: engineStatus.classList.remove('active-engine');
    // 4. Set intensity back to 10.
    
    let currentIntensity = 15;
    setInterval(() => animateEngine(currentIntensity), 100);
</script>
</body>
</html>
