<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" href="https://raw.githubusercontent.com/ghostm68/inktwo/main/Images/favicon.ico" />
    <title>2471 | Z.AI NEURAL TERMINAL</title>
    <style>
        :root {
            --bg: #0a0a0a;
            --panel: #121212;
            --border: #222;
            --red: #ff4444;
            --grey: #555;
            --text: #eee;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Georgia', serif;
            margin: 0;
            padding: 1rem;
            overflow: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr 1.2fr;
            gap: 1rem;
            max-width: 1800px;
            margin: 0 auto;
            height: calc(100vh - 80px);
        }

        .panel {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 1.2rem;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        h2 {
            color: var(--red);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
            margin-top: 0;
        }

        textarea, input, select {
            background: #000;
            color: #fff;
            border: 1px solid var(--border);
            padding: 10px;
            margin-bottom: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        /* 2471 RED SLIDER */
        input[type="range"] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type="range"]::-webkit-slider-runnable-track { width: 100%; height: 2px; background: var(--red); }
        input[type="range"]::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 16px; width: 16px; 
            background: var(--red); border-radius: 0; margin-top: -7px; cursor: pointer; 
        }

        button {
            background: transparent;
            color: #fff;
            border: 1px solid var(--red);
            padding: 12px;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 1px;
            transition: 0.2s;
        }

        button:hover { background: var(--red); color: #000; font-weight: bold; }
        button:disabled { opacity: 0.3; border-color: var(--grey); }

        #output-area {
            flex: 1;
            background: #050505;
            padding: 15px;
            border: 1px solid #1a1a1a;
            overflow-y: auto;
            font-size: 0.95rem;
            line-height: 1.7;
            white-space: pre-wrap;
        }

        #notepad { flex: 1; background: #050505; border: 1px solid #1a1a1a; resize: none; color: #aaa; }

        /* KALI BAR GRAPH STYLE */
        .kali-container {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 30px;
            margin-top: 10px;
            padding: 5px;
            background: #000;
        }
        .kali-bar {
            width: 5px;
            background: #222;
            /* Segmented Effect */
            background-image: linear-gradient(to bottom, rgba(0,0,0,0.5) 1px, transparent 1px);
            background-size: 100% 3px;
            transition: height 0.1s ease;
        }
        .active-engine .kali-bar { background-color: var(--red); }

        .status-footer {
            margin-top: 10px;
            font-size: 0.6rem;
            color: #444;
            text-align: center;
            text-transform: uppercase;
        }
    </style>
</head>
<body>

    <div style="text-align: center; margin-bottom: 10px;">
        <h1 style="margin:0; font-size: 1.2rem; letter-spacing: 5px; color: var(--text);">PROTOCOL 2471</h1>
    </div>

    <div class="container">
        <!-- COL 1: ARCHIVE -->
        <div class="panel">
            <h2>Archive / Notepad</h2>
            <textarea id="notepad" placeholder="Storage for generated artifacts..."></textarea>
            <button id="exportBtn" style="margin-top:10px;">Export TXT</button>
        </div>

        <!-- COL 2: COMMAND -->
        <div class="panel">
            <h2>Command Console</h2>
            <label style="font-size: 0.6rem; color: #666;">Z.AI API ACCESS KEY</label>
            <input type="password" id="apiKey" placeholder="z.ai-...">
            
            <label style="font-size: 0.6rem; color: #666;">MODEL IDENTIFIER</label>
            <select id="modelId">
                <option value="glm-4-flash">GLM-4-Flash (Free/Stable)</option>
                <option value="glm-4-air">GLM-4-Air (Industrial)</option>
                <option value="glm-4-plus">GLM-4-Plus (Frontier)</option>
            </select>

            <div style="display:flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <input type="checkbox" id="thinkingMode" checked>
                <label for="thinkingMode" style="font-size: 0.6rem; margin:0;">ENABLE NEURAL THINKING</label>
            </div>

            <label style="font-size: 0.6rem; color: #666;">NARRATIVE PARAMETERS</label>
            <textarea id="prompt" style="height: 120px;" placeholder="Input story seed..."></textarea>

            <label style="font-size: 0.6rem; color: #666;">ENTROPY: <span id="tempDisp">0.6</span></label>
            <input type="range" id="temp" min="0" max="1" step="0.1" value="0.6">

            <button id="execBtn" style="margin-top: 10px; font-size: 0.9rem;">Execute Generation</button>
        </div>

        <!-- COL 3: OUTPUT -->
        <div class="panel" id="outputPanel">
            <h2>System Output</h2>
            <div id="output-area">Terminal Standby...</div>
            
            <div class="kali-container" id="kaliGrid"></div>
            
            <button id="transferBtn" style="margin-top:10px;" disabled>➔ Transfer to Archive</button>
        </div>
    </div>

    <div class="status-footer">
        Z.AI PAAS V4 • INTEGRATED KALI-SPEC UI • 2471-INDUSTRIAL
    </div>

    <script>
        // 1. Initial UI Setup
        const tempInput = document.getElementById('temp');
        tempInput.oninput = () => document.getElementById('tempDisp').innerText = tempInput.value;

        // Load Key from storage
        const savedKey = localStorage.getItem('zai_2471_key');
        if(savedKey) document.getElementById('apiKey').value = savedKey;

        // Create Kali Bars
        const kaliGrid = document.getElementById('pulseGrid');
        for(let i=0; i<30; i++) {
            const bar = document.createElement('div');
            bar.className = 'kali-bar';
            document.getElementById('kaliGrid').appendChild(bar);
        }

        // 2. The Kali Bar Animation Logic
        let engineActive = false;
        function updateBars() {
            const bars = document.querySelectorAll('.kali-bar');
            bars.forEach(bar => {
                const height = engineActive ? (Math.random() * 80 + 20) : (Math.random() * 10 + 5);
                bar.style.height = height + '%';
            });
        }
        setInterval(updateBars, 100);

        // 3. THE EXECUTE BUTTON LOGIC (THE HEART)
        document.getElementById('execBtn').onclick = async () => {
            const btn = document.getElementById('execBtn');
            const out = document.getElementById('output-area');
            const key = document.getElementById('apiKey').value.trim();
            const model = document.getElementById('modelId').value;
            const prompt = document.getElementById('prompt').value.trim();
            const think = document.getElementById('thinkingMode').checked;

            if(!key || !prompt) return alert("System Error: Key and Prompt Required.");
            
            // Save Key for next time
            localStorage.setItem('zai_2471_key', key);

            // UI Feedback
            btn.disabled = true;
            btn.textContent = "Processing...";
            out.innerHTML = "<span style='color:#444'>Linking to Z.AI Nodes...</span>";
            engineActive = true;
            document.getElementById('outputPanel').classList.add('active-engine');

            try {
                // Proxy is needed to bypass browser security (CORS)
                const apiUrl = "https://api.z.ai/api/paas/v4/chat/completions";
                const proxyUrl = "https://corsproxy.io/?" + encodeURIComponent(apiUrl);

                const response = await fetch(proxyUrl, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${key}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: "user", content: prompt }],
                        stream: true,
                        temperature: parseFloat(tempInput.value),
                        max_tokens: 4096,
                        ...(think && { thinking: { type: "enabled" } })
                    })
                });

                if (!response.ok) {
                    const errorJson = await response.json();
                    throw new Error(errorJson.error.message || "Connection Failed");
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullText = "";
                let thinkingText = "";
                out.innerHTML = ""; // Clear for output

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split("\n");

                    for (const line of lines) {
                        const trimmed = line.trim();
                        if (!trimmed || trimmed === "data: [DONE]") continue;

                        if (trimmed.startsWith("data: ")) {
                            try {
                                const json = JSON.parse(trimmed.slice(6));
                                const delta = json.choices[0].delta;

                                // Reasoning content for "Thinking" mode
                                const thought = delta.reasoning_content || "";
                                const content = delta.content || "";

                                if (thought) {
                                    thinkingText += thought;
                                    out.innerHTML = `<div style="color:#555; font-size:0.8rem; font-style:italic; border-left:1px solid #333; padding-left:10px; margin-bottom:10px;">[INTERNAL_LOGIC]: ${thinkingText}</div>` + fullText;
                                }

                                if (content) {
                                    fullText += content;
                                    out.innerHTML = (thinkingText ? `<div style="color:#555; font-size:0.8rem; font-style:italic; border-left:1px solid #333; padding-left:10px; margin-bottom:10px;">[INTERNAL_LOGIC]: ${thinkingText}</div>` : "") + 
                                                    `<div style="color:#eee;">${fullText}</div>`;
                                }
                                out.scrollTop = out.scrollHeight;
                            } catch (e) {}
                        }
                    }
                }
                document.getElementById('transferBtn').disabled = false;

            } catch (err) {
                out.innerHTML = `<span style="color:var(--red)">TERMINAL_CRASH: ${err.message}</span>`;
            } finally {
                btn.disabled = false;
                btn.textContent = "Execute Generation";
                engineActive = false;
                document.getElementById('outputPanel').classList.remove('active-engine');
            }
        };

        // Transfer logic
        document.getElementById('transferBtn').onclick = () => {
            const note = document.getElementById('notepad');
            const out = document.getElementById('output-area').innerText;
            note.value += (note.value ? "\n\n--- NEW ENTRY ---\n" : "") + out;
        };

        // Export logic
        document.getElementById('exportBtn').onclick = () => {
            const blob = new Blob([document.getElementById('notepad').value], {type: "text/plain"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = "2471_archive.txt";
            a.click();
        };
    </script>
</body>
</html>
