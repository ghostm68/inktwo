<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>bRIM Literary Work</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.puter.com/v2/"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    body {
      font-family: 'Courier New', monospace;
    }
    .highlight {
      background-color: #ffcb6b;
      color: #1a202c;
      padding: 1px 3px;
      border-radius: 2px;
    }
    .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #1a202c;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background-color: #6b46c1;
      border-radius: 4px;
      border: 2px solid #1a202c;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background-color: #805ad5;
    }

    .prose {
      color: #e2e8f0;
    }
    .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
      color: #d8b4fe;
      font-weight: bold;
      margin-top: 1.5em;
      margin-bottom: 0.5em;
      line-height: 1.25;
    }
    .prose h1 { font-size: 2.25em; }
    .prose h2 { font-size: 1.875em; }
    .prose h3 { font-size: 1.5em; }
    .prose h4 { font-size: 1.25em; }
    .prose p {
      margin-top: 1em;
      margin-bottom: 1em;
    }
    .prose ul, .prose ol {
      margin-top: 1em;
      margin-bottom: 1em;
      padding-left: 1.5em;
    }
    .prose li {
      margin-bottom: 0.5em;
    }
    .prose a {
      color: #a78bfa;
      text-decoration: underline;
    }
    .prose blockquote {
      border-left: 0.25em solid #6b46c1;
      padding-left: 1em;
      color: #cbd5e0;
      font-style: italic;
    }
    .prose pre {
      background-color: #2d3748;
      color: #e2e8f0;
      padding: 1em;
      border-radius: 0.25rem;
      overflow-x: auto;
    }
    .prose code {
      background-color: #4a5568;
      color: #ffcb6b;
      padding: 0.2em 0.4em;
      border-radius: 0.25rem;
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-200 font-mono antialiased p-4 sm:p-6 md:p-8">
  <div class="max-w-4xl mx-auto">
    <div id="controls" class="sticky top-0 bg-gray-900 pt-4 pb-6 border-b border-gray-700 z-10">
      <h1 class="text-3xl font-bold text-purple-400 mb-4">bR/im Literary Works</h1>

      <input
        type="text"
        id="searchBox"
        class="w-full bg-gray-800 border border-gray-600 text-gray-200 p-2 text-sm focus:outline-none focus:border-purple-500 transition-all duration-300 mb-2"
        placeholder="Search: korea AND flying, siti OR doan , dream -anxiety, &quot;exact phrase&quot;"
        aria-label="Search entries"
      />
      <div id="searchStats" class="text-xs text-gray-500 min-h-[14px] mb-4"></div>

      <div class="flex flex-wrap items-center justify-center sm:justify-start gap-2 mb-4">
        <button id="randomBtn" class="bg-transparent border border-purple-500 text-purple-500 py-2 px-4 text-sm hover:bg-purple-500 hover:text-gray-900 transition-colors duration-300" aria-label="Show random entry">‚úß---‚úß</button>
        <button id="indexBtn" class="bg-transparent border border-purple-500 text-purple-500 py-2 px-4 text-sm hover:bg-purple-500 hover:text-gray-900 transition-colors duration-300" aria-label="Toggle date index">Date Index</button>

      </div>

      <div id="filterBtns" class="flex flex-wrap items-center justify-center sm:justify-start gap-2 mb-4">
        <button class="filter-btn bg-transparent border border-gray-600 text-gray-400 py-1 px-3 text-xs hover:bg-gray-700 hover:border-purple-500 transition-colors duration-300" data-filter="all">All</button>
        <button class="filter-btn bg-transparent border border-purple-300 text-purple-300 py-1 px-3 text-xs hover:bg-purple-300 hover:text-gray-900 transition-colors duration-300" data-filter="chapters">Chapters</button>
        <button class="filter-btn bg-transparent border border-indigo-400 text-indigo-400 py-1 px-3 text-xs hover:bg-indigo-400 hover:text-gray-900 transition-colors duration-300" data-filter="annotations">Annotations</button>
        <button class="filter-btn bg-transparent border border-orange-400 text-orange-400 py-1 px-3 text-xs hover:bg-orange-400 hover:text-gray-900 transition-colors duration-300" data-filter="hypothesis">Hypothesis</button>
        <button class="filter-btn bg-transparent border border-emerald-400 text-emerald-400 py-1 px-3 text-xs hover:bg-emerald-400 hover:text-gray-900 transition-colors duration-300" data-filter="interlude">Interludes</button>
        <button class="filter-btn bg-transparent border border-rose-400 text-rose-400 py-1 px-3 text-xs hover:bg-rose-400 hover:text-gray-900 transition-colors duration-300" data-filter="chronology">Chronology</button>
      </div>
      <div id="dateNav" class="mt-4 max-h-80 overflow-y-auto border border-gray-700 p-2 transition-all duration-300 hidden custom-scrollbar"></div>
      
      <div class="mt-4" id="puterModelSelectContainer">
        <label for="puter-model-select" class="block text-sm font-medium text-gray-400 mb-1">
          Select AI Model 
        </label>
        <select
          id="puter-model-select"
          class="w-full p-2 bg-gray-800 border border-gray-700 rounded-md text-gray-200 focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
          aria-label="Select AI model"
        ></select>
        <p class="text-xs text-gray-500 mt-1">
          These models are provided via the Puter SDK.
        </p>
      </div>

      <div class="mt-8 pt-6 border-t border-gray-700">
        <h2 class="text-2xl font-bold text-purple-400 mb-4">AI</h2>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-400 mb-2">Context for AI:</label>
          <div class="flex flex-wrap gap-2">
            <button class="context-btn bg-purple-600 border border-purple-600 text-white py-1 px-3 text-xs hover:bg-purple-700 transition-colors duration-300" data-context="current">Current Entry</button>
            <button class="context-btn bg-gray-700 border border-gray-600 text-gray-300 py-1 px-3 text-xs hover:bg-gray-600 transition-colors duration-300" data-context="all">All Entries</button>
            <button class="context-btn bg-gray-700 border border-gray-600 text-gray-300 py-1 px-3 text-xs hover:bg-gray-600 transition-colors duration-300" data-context="none">No Context</button>
          </div>
          <p class="text-xs text-gray-500 mt-1" id="contextInfo">AI will have access to the entry you're currently reading</p>
        </div>
        
        <div class="mb-4">
          <label for="aiInput" class="block text-sm font-medium text-gray-400 mb-1">Your message to the AI:</label>
          <textarea id="aiInput" class="w-full bg-gray-800 border border-gray-600 text-gray-200 p-2 text-sm focus:outline-none focus:border-purple-500 transition-all duration-300 min-h-[80px]" placeholder="Ask about themes, analysis, connections, or anything else..." aria-label="AI input text area"></textarea>
        </div>
        <button id="askAiBtn" class="bg-purple-600 text-white py-2 px-6 text-sm hover:bg-purple-700 transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed" aria-label="Ask AI">Ask AI</button>
        <div class="mb-4 mt-6">
          <label for="aiResponse" class="block text-sm font-medium text-gray-400 mb-1">AI Response:</label>
          <div id="aiResponse" class="w-full bg-gray-800 border border-gray-600 text-gray-200 p-3 text-sm min-h-[120px] max-h-[500px] overflow-y-auto custom-scrollbar whitespace-pre-wrap" aria-live="polite" aria-atomic="true">
            <p class="text-gray-500 italic">Responses from the selected AI model will appear here.</p>
          </div>
        </div>
      </div>

      <div id="entryInfo" class="text-gray-500 text-xs mt-4 mb-4"></div>
    </div>

    <div id="loading" class="text-center py-12 text-purple-400 text-lg">Loading content...</div>
    <div id="content" class="text-sm leading-relaxed" style="display:none;"></div>
  </div>

  <script>
    const CONTENT_BASE_URL = 'https://raw.githubusercontent.com/ghostm68/inktwo/refs/heads/main/brim.txt/';
    const CONTENT_FILES = [
      'https://inkrealm.info/brim.txt',
    
    ];

    const TAG_PATTERNS = {
      all: /.*/,
      chapters: /\[chapters\]|\bchapter(s)?\b|\blyric(s)?\b/i,
      annotations: /\[annotations\]|\bannotation(s)?\b|\bpoem(s)?\b/i,
      hypothesis: /\[hypothesis\]|\bhypothesis(es)?\b|\bfilm(s)?\b|\bmovie(s)?\b/i,
      interlude: /\[interlude\]|\binterlude(s)?\b|\bbook(s)?\b|\breading\b/i,
      chronology: /\[chronology\]|\bchronology(ies)?\b|\bdream(s)?\b|\bdreamt\b/i
    };

    const AVAILABLE_PUTER_MODELS = [
      { group: 'Google Models', options: [
        { value: 'google/gemma-3-4b-it:free', label: 'Gemma 3 4B ‚úÖ' },
        { value: 'google/gemma-2-9b-it:free', label: 'Gemma 2 9B ‚úÖ' },
        { value: 'google/gemma-3-12b-it:free', label: 'Gemma 3 12B ‚úÖ' },
      ]},
      { group: 'üöÄ DeepSeek Models (Recommended)', options: [
        { value: 'deepseek-chat', label: 'DeepSeek Chat (V3)' },
        { value: 'deepseek-reasoner', label: 'DeepSeek Reasoner (R1)' },
      ]}
    ];

    let entries = [];
    let currentIndex = -1;
    let currentFilter = 'all';
    let searchQuery = '';
    let searchResults = [];
    let isSearching = false;
    let isDateIndexVisible = false;
    let selectedPuterModel = AVAILABLE_PUTER_MODELS[0]?.options[0]?.value || '';
    let searchTimeout = null;
    let aiContext = 'current';

    const searchBox = document.getElementById('searchBox');
    const searchStats = document.getElementById('searchStats');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const randomBtn = document.getElementById('randomBtn');
    const indexBtn = document.getElementById('indexBtn');
    const jumpStartBtn = document.getElementById('jumpStart');
    const jumpEndBtn = document.getElementById('jumpEnd');
    const filterBtns = document.getElementById('filterBtns');
    const dateNav = document.getElementById('dateNav');
    const entryInfo = document.getElementById('entryInfo');
    const loadingDiv = document.getElementById('loading');
    const contentDiv = document.getElementById('content');
    const puterModelSelect = document.getElementById('puter-model-select');
    const aiInput = document.getElementById('aiInput');
    const askAiBtn = document.getElementById('askAiBtn');
    const aiResponseDiv = document.getElementById('aiResponse');
    const contextInfo = document.getElementById('contextInfo');
    
    function debounce(func, delay) {
      return function(...args) {
        if (searchTimeout) {
          clearTimeout(searchTimeout);
        }
        searchTimeout = setTimeout(() => {
          func.apply(this, args);
        }, delay);
      };
    }

    function escapeRegex(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function parseSearchQuery(query) {
      const terms = {
        and: [],
        or: [],
        not: [],
        exact: []
      };

      const exactMatches = query.match(/"([^"]+)"/g);
      if (exactMatches) {
        exactMatches.forEach(match => {
          const phrase = match.replace(/"/g, '');
          terms.exact.push(phrase.toLowerCase());
          query = query.replace(match, '');
        });
      }

      const words = query.toLowerCase().split(/\s+/).filter(w => w);
      let currentOp = 'and';

      words.forEach(word => {
        if (word === 'and') {
          currentOp = 'and';
        } else if (word === 'or') {
          currentOp = 'or';
        } else if (word.startsWith('-')) {
          terms.not.push(word.substring(1));
        } else if (word) {
          terms[currentOp].push(word);
        }
      });
      return terms;
    }

    function matchesSearch(entry, terms) {
      const content = entry.content.toLowerCase();
      const date = entry.date.toLowerCase();
      const searchText = content + ' ' + date;

      for (let i = 0; i < terms.not.length; i++) {
        if (searchText.includes(terms.not[i])) {
          return false;
        }
      }

      for (let i = 0; i < terms.exact.length; i++) {
        if (!searchText.includes(terms.exact[i])) {
          return false;
        }
      }

      for (let i = 0; i < terms.and.length; i++) {
        if (!searchText.includes(terms.and[i])) {
          return false;
        }
      }

      if (terms.or.length > 0) {
        let orMatch = false;
        for (let i = 0; i < terms.or.length; i++) {
          if (searchText.includes(terms.or[i])) {
            orMatch = true;
            break;
          }
        }
        if (!orMatch) return false;
      }

      return true;
    }

    function highlightSearchTermsInHtml(htmlContent, query) {
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = htmlContent;

      const searchTerms = parseSearchQuery(query);
      const termsToHighlight = [
        ...searchTerms.exact,
        ...searchTerms.and,
        ...searchTerms.or
      ].filter((term, i, self) => term.length > 0 && self.indexOf(term) === i);

      termsToHighlight.sort((a, b) => b.length - a.length);

      function highlightTextNodes(node) {
        if (node.nodeType === Node.TEXT_NODE) {
          let text = node.nodeValue;
          let newHtml = text;

          for (const term of termsToHighlight) {
            const regex = new RegExp(`(${escapeRegex(term)})`, 'gi');
            newHtml = newHtml.replace(regex, '<span class="highlight">$&</span>');
          }

          if (newHtml !== text) {
            const tempSpan = document.createElement('span');
            tempSpan.innerHTML = newHtml;
            while (tempSpan.firstChild) {
              node.parentNode.insertBefore(tempSpan.firstChild, node);
            }
            node.parentNode.removeChild(node);
          }
        } else if (node.nodeType === Node.ELEMENT_NODE && node.nodeName !== 'SCRIPT' && node.nodeName !== 'STYLE' && node.className !== 'highlight') {
          for (let i = 0; i < node.childNodes.length; i++) {
            highlightTextNodes(node.childNodes[i]);
          }
        }
      }

      highlightTextNodes(tempDiv);
      return tempDiv.innerHTML;
    }

    function getTagClass(tag) {
      switch (tag) {
        case 'chapters': return 'border-purple-300 text-purple-300';
        case 'annotations': return 'border-indigo-400 text-indigo-400';
        case 'hypothesis': return 'border-orange-400 text-orange-400';
        case 'interlude': return 'border-emerald-400 text-emerald-400';
        case 'chronology': return 'border-rose-400 text-rose-400';
        default: return 'border-gray-600 text-gray-400';
      }
    }

    async function loadAndParseContent() {
      try {
        const fetchedEntries = [];
        let entryIdCounter = 0;

        for (const filename of CONTENT_FILES) {
          const response = await fetch(CONTENT_BASE_URL + filename);
          if (!response.ok) {
            console.warn(`Could not load ${filename} from ${CONTENT_BASE_URL}, skipping. Status: ${response.status}`);
            continue;
          }
          const text = await response.text();
          const entryName = filename.replace('.md', '')
                                    .split(/[-_]/)
                                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                                    .join(' ');
          
          const newEntry = {
            id: entryIdCounter++,
            date: entryName,
            content: text,
            tags: []
          };
          detectTags(newEntry);
          fetchedEntries.push(newEntry);
        }
        
        entries = fetchedEntries;
        
        loadingDiv.style.display = 'none';
        contentDiv.style.display = 'block';

        if (entries.length > 0) {
          const initialFilteredEntries = getFilteredEntries();
          if (initialFilteredEntries.length > 0) {
            showEntry(initialFilteredEntries[0].id);
          } else {
            showEntry(entries[0].id); 
          }
        } else {
            showEntry(-1);
            loadingDiv.innerHTML = '<p class="text-red-500">No content files could be loaded or parsed. Check console for details.</p>';
            loadingDiv.style.display = 'block';
        }
        buildDateIndex();
      } catch (error) {
        loadingDiv.innerHTML =
          `<p class="text-red-500">Error loading content. Please check the console for details.</p><br>
          <small>Error: ${error.message}</small>`;
        loadingDiv.style.display = 'block';
        contentDiv.style.display = 'none';
        contentDiv.innerHTML = '';
        entryInfo.textContent = '';
        console.error("Error loading or parsing content:", error);
      }
    }

    function detectTags(entry) {
      for (const tag in TAG_PATTERNS) {
        if (tag === 'all') continue;
        if (TAG_PATTERNS[tag].test(entry.content)) {
          entry.tags.push(tag);
        }
      }
    }

    function getFilteredEntries() {
      if (currentFilter === 'all') return entries;
      return entries.filter(entry => entry.tags.includes(currentFilter));
    }

    function updateSearchStats() {
      if (isSearching) {
        searchStats.textContent = `${searchResults.length} matches`;
      } else {
        const filteredCount = getFilteredEntries().length;
        if (currentFilter !== 'all') {
             searchStats.textContent = `${filteredCount} entries tagged '${currentFilter}'.`;
        } else {
            searchStats.textContent = '';
        }
      }
    }

    function performSearch(query) {
      searchQuery = query;
      if (!query.trim()) {
        isSearching = false;
        searchResults = [];
        updateSearchStats();
        buildDateIndex();
        const firstFilteredEntries = getFilteredEntries();
        if (firstFilteredEntries.length > 0) {
          showEntry(firstFilteredEntries[0].id);
        } else {
          showEntry(-1);
        }
        return;
      }

      isSearching = true;
      const terms = parseSearchQuery(query);
      searchResults = [];

      getFilteredEntries().forEach((entry) => {
        if (matchesSearch(entry, terms)) {
          searchResults.push({ entry, id: entry.id });
        }
      });

      updateSearchStats();
      buildDateIndex();

      if (searchResults.length > 0) {
        showEntry(searchResults[0].id);
      } else {
        showEntry(-1);
      }
    }

    function showEntry(entryId) {
      if (entries.length === 0) {
        contentDiv.innerHTML = '<p class="text-gray-500 text-lg text-center">No content loaded.</p>';
        entryInfo.textContent = '';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        currentIndex = -1;
        return;
      }

      const entry = entries.find(e => e.id === entryId);

      if (!entry) {
        contentDiv.innerHTML = '<p class="text-gray-500 text-lg text-center">No matching entry found for current criteria.</p>';
        entryInfo.textContent = 'No results found or entry not available for current filter/search.';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        currentIndex = -1;
        return;
      }
      
      currentIndex = entry.id;

      let displayContentHtml = marked.parse(entry.content);
      if (isSearching && searchQuery.trim()) {
        displayContentHtml = highlightSearchTermsInHtml(displayContentHtml, searchQuery);
      }

      contentDiv.innerHTML = `<div class="prose prose-invert">${displayContentHtml}</div>`;

      let currentViewableItems;
      if (isSearching) {
        currentViewableItems = searchResults;
      } else {
        currentViewableItems = getFilteredEntries().map(e => ({entry: e, id: e.id}));
      }

      const currentEntryInViewableIndex = currentViewableItems.findIndex(item => item.id === currentIndex);

      const resultInfo = isSearching && searchResults.length > 0
        ? ` ‚Ä¢ Result ${currentEntryInViewableIndex + 1} of ${searchResults.length}`
        : '';
      const filterInfo = currentFilter !== 'all' ? ` (Filtered by '${currentFilter}')` : '';

      entryInfo.innerHTML = `Entry: <span class="text-purple-300">${entry.date}</span> ${resultInfo}${filterInfo}
        <div class="inline-flex ml-2">${entry.tags.map(tag => `<span class="inline-block px-2 py-0.5 ml-1 text-xs rounded-sm border ${getTagClass(tag)}">${tag}</span>`).join('')}</div>`;


      prevBtn.disabled = currentEntryInViewableIndex <= 0;
      nextBtn.disabled = currentEntryInViewableIndex >= currentViewableItems.length - 1;

      window.scrollTo({ top: 0, behavior: 'smooth' });
      updateSearchStats();
    }

    function buildDateIndex() {
      dateNav.innerHTML = '';

      const itemsToDisplay = isSearching ? searchResults : getFilteredEntries().map((entry) => ({
        entry,
        id: entry.id
      }));

      if (itemsToDisplay.length === 0) {
        const noEntriesMessage = document.createElement('p');
        noEntriesMessage.className = 'text-gray-500 text-sm p-2';
        noEntriesMessage.textContent = 'No entries found for this filter/search.';
        dateNav.appendChild(noEntriesMessage);
        return;
      }

      itemsToDisplay.forEach(({ entry, id }) => {
        const dateLink = document.createElement('div');
        dateLink.className = 'group block p-2 cursor-pointer border-b border-gray-800 last:border-b-0 hover:bg-gray-800 transition-colors duration-200';
        dateLink.setAttribute('data-id', id);
        dateLink.setAttribute('tabindex', '0');
        dateLink.setAttribute('role', 'button');
        
        const tagsHtml = entry.tags.map(tag =>
          `<span class="inline-block px-2 py-0.5 ml-2 text-xs rounded-sm border ${getTagClass(tag)}">${tag}</span>`
        ).join('');

        let previewHtml = '';
        const snippetText = marked.parse(entry.content).replace(/<[^>]*>/g, '').substring(0, 100).replace(/\n/g, ' ').trim();
        previewHtml = `<div class="text-xs text-gray-500 mt-1 italic">${snippetText}...</div>`;
        

        dateLink.innerHTML = `
          <div class="flex items-center text-purple-400 group-hover:text-purple-300 text-sm">
            ${entry.date} ${tagsHtml}
          </div>
          ${previewHtml}
        `;

        dateLink.addEventListener('click', () => {
          showEntry(id);
          dateNav.classList.remove('block');
          dateNav.classList.add('hidden');
          isDateIndexVisible = false;
        });
        dateLink.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            showEntry(id);
            dateNav.classList.remove('block');
            dateNav.classList.add('hidden');
            isDateIndexVisible = false;
          }
        });
        dateNav.appendChild(dateLink);
      });
    }

    function showRandomEntry() {
      const pool = isSearching
        ? searchResults.map(r => r.id)
        : getFilteredEntries().map(entry => entry.id);

      if (pool.length > 0) {
        const randomIndex = pool[Math.floor(Math.random() * pool.length)];
        showEntry(randomIndex);
      } else {
        showEntry(-1);
      }
    }

    function navigateEntries(direction) {
        let currentViewableItems;
        if (isSearching) {
            currentViewableItems = searchResults;
        } else {
            currentViewableItems = getFilteredEntries().map(e => ({entry: e, id: e.id}));
        }

        if (currentViewableItems.length === 0 || currentIndex === -1) {
            if (currentViewableItems.length > 0) {
                showEntry(currentViewableItems[0].id);
            }
            return;
        }

        const currentEntryViewableIndex = currentViewableItems.findIndex(item => item.id === currentIndex);

        let newEntryViewableIndex;
        if (direction === 'next') {
            newEntryViewableIndex = (currentEntryViewableIndex + 1);
            if (newEntryViewableIndex >= currentViewableItems.length) {
                newEntryViewableIndex = currentViewableItems.length - 1;
            }
        } else {
            newEntryViewableIndex = (currentEntryViewableIndex - 1);
            if (newEntryViewableIndex < 0) {
                newEntryViewableIndex = 0;
            }
        }
        
        if (newEntryViewableIndex !== currentEntryViewableIndex) {
            showEntry(currentViewableItems[newEntryViewableIndex].id);
        }
    }

    function populatePuterModels() {
      puterModelSelect.innerHTML = '';

      AVAILABLE_PUTER_MODELS.forEach(group => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = group.group;
        optgroup.className = 'text-gray-400 font-semibold';

        group.options.forEach(model => {
          const option = document.createElement('option');
          option.value = model.value;
          option.textContent = model.label;
          option.className = 'text-gray-200';
          optgroup.appendChild(option);
        });
        puterModelSelect.appendChild(optgroup);
      });

      puterModelSelect.value = selectedPuterModel;
    }

    function buildAIPrompt(userMessage) {
      let systemContext = '';
      
      if (aiContext === 'current' && currentIndex !== -1) {
        const currentEntry = entries.find(e => e.id === currentIndex);
        if (currentEntry) {
          const contentPreview = currentEntry.content.substring(0, 3000);
          const truncated = currentEntry.content.length > 3000 ? '... [content truncated]' : '';
          systemContext = `You are analyzing a literary work. Here is the current entry the user is reading:\n\nTitle: ${currentEntry.date}\nTags: ${currentEntry.tags.join(', ')}\n\nContent:\n${contentPreview}${truncated}\n\n---\n\nUser's question: `;
        }
      } else if (aiContext === 'all') {
        const entryList = entries.map(e => `- ${e.date} (${e.tags.join(', ')})`).join('\n');
        const totalWords = entries.reduce((sum, e) => sum + e.content.split(/\s+/).length, 0);
        systemContext = `You are analyzing a collection of literary works with ${entries.length} entries and approximately ${totalWords} words.\n\nEntries:\n${entryList}\n\n---\n\nUser's question: `;
      }
      
      return systemContext + userMessage;
    }

    async function generateWithPuterAI(prompt, model, responseElement) {
        responseElement.innerHTML = `<p class="text-purple-400 animate-pulse">Connecting to ${model}... Please wait.</p>`;
        
        try {
            let responseText = '';
            const fullPrompt = buildAIPrompt(prompt);
            
            if (model.includes('deepseek')) {
                const response = await puter.ai.chat(fullPrompt, { 
                    model: model,
                    temperature: 0.7,
                    max_tokens: 2000
                });
                responseText = response;
            } else {
                const response = await puter.ai.chat(fullPrompt, { 
                    model: model,
                    temperature: 0.7,
                    max_tokens: 2000
                });
                responseText = response;
            }
            
            responseElement.textContent = `‚úÖ Response:\n\n${responseText}`;
            
        } catch (error) {
            console.error("Puter API error:", error);
            
            let errorMessage = `An error occurred with model ${model}: ${error.message}`;
            if (error.message.includes('rate limit') || error.message.includes('quota')) {
                errorMessage = `‚è±Ô∏è Rate limit exceeded for ${model}. Try again in a few moments or use a different model.`;
            } else if (error.message.includes('auth') || error.message.includes('login')) {
                errorMessage = `üîê Authentication required for ${model}.\n\nPuter.js requires email confirmation for full API access.`;
            } else if (error.message.includes('Network Error')) {
                errorMessage = `üåê Network error: Could not reach Puter.js API. Check your internet connection.`;
            }
            responseElement.innerHTML = `<p class="text-red-400">‚ùå ${errorMessage}</p><p class="text-xs text-gray-500 mt-2">Check the console for more details.</p>`;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadAndParseContent();
      populatePuterModels();
      const allFilterBtn = document.querySelector('.filter-btn[data-filter="all"]');
      if (allFilterBtn) {
          allFilterBtn.classList.add('bg-purple-500', 'text-gray-900', 'border-purple-500');
      }
    });

    searchBox.addEventListener('input', debounce((e) => {
      performSearch(e.target.value);
    }, 300));

    prevBtn.addEventListener('click', () => {
      navigateEntries('prev');
    });

    nextBtn.addEventListener('click', () => {
      navigateEntries('next');
    });

    randomBtn.addEventListener('click', showRandomEntry);

    indexBtn.addEventListener('click', () => {
      isDateIndexVisible = !isDateIndexVisible;
      if (isDateIndexVisible) {
        dateNav.classList.remove('hidden');
        dateNav.classList.add('block');
      } else {
        dateNav.classList.add('hidden');
        dateNav.classList.remove('block');
      }
      buildDateIndex();
    });

    jumpStartBtn.addEventListener('click', () => {
      let targetId;
      let currentViewableItems = isSearching ? searchResults : getFilteredEntries().map(e => ({entry: e, id: e.id}));
      if (currentViewableItems.length > 0) {
        targetId = currentViewableItems[0].id;
      } else {
        targetId = -1;
      }
      showEntry(targetId);
    });

    jumpEndBtn.addEventListener('click', () => {
      let targetId;
      let currentViewableItems = isSearching ? searchResults : getFilteredEntries().map(e => ({entry: e, id: e.id}));
      if (currentViewableItems.length > 0) {
        targetId = currentViewableItems[currentViewableItems.length - 1].id;
      } else {
        targetId = -1;
      }
      showEntry(targetId);
    });

    filterBtns.addEventListener('click', (e) => {
      if (e.target.classList.contains('filter-btn')) {
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.classList.remove('bg-purple-500', 'text-gray-900');
          const tag = btn.dataset.filter;
          if (tag === 'all') {
            btn.classList.remove('border-purple-500', getTagClass(tag).split(' ')[0]);
            btn.classList.add('border-gray-600', 'text-gray-400');
          } else {
            btn.classList.remove('border-purple-500');
            const classesToAdd = getTagClass(tag).split(' ').filter(cls => cls !== '');
            btn.classList.add(...classesToAdd);
          }
        });

        e.target.classList.add('bg-purple-500', 'text-gray-900', 'border-purple-500');
        const clickedTag = e.target.dataset.filter;
        if (clickedTag !== 'all') {
             const classesToRemove = getTagClass(clickedTag).split(' ').filter(cls => cls !== '');
             e.target.classList.remove(...classesToRemove);
        }
        
        currentFilter = e.target.dataset.filter;

        if (isSearching && searchQuery.trim()) {
          performSearch(searchQuery);
        } else {
          const filtered = getFilteredEntries();
          if (filtered.length > 0) {
            showEntry(filtered[0].id);
          } else {
            showEntry(-1);
          }
          buildDateIndex();
          isDateIndexVisible = true;
          dateNav.classList.remove('hidden');
          dateNav.classList.add('block');
        }
      }
    });

    puterModelSelect.addEventListener('change', (e) => {
      selectedPuterModel = e.target.value;
      console.log('Selected Puter Model:', selectedPuterModel);
    });

    askAiBtn.addEventListener('click', async () => {
      const userMessage = aiInput.value.trim();
      if (!userMessage) {
        aiResponseDiv.innerHTML = '<p class="text-red-400">Please enter a message for the AI.</p>';
        return;
      }

      askAiBtn.disabled = true;
      aiInput.disabled = true;

      try {
        const selectedModel = puterModelSelect.value;
        console.log(`Asking AI with model: ${selectedModel}, context: ${aiContext}, message: "${userMessage}"`);
        await generateWithPuterAI(userMessage, selectedModel, aiResponseDiv);
      } catch (error) {
        aiResponseDiv.innerHTML = `<p class="text-red-400">An unexpected error occurred: ${error.message}</p>`;
        console.error('AI Request Top-level Error:', error);
      } finally {
        askAiBtn.disabled = false;
        aiInput.disabled = false;
        aiInput.value = '';
      }
    });

    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('context-btn')) {
        document.querySelectorAll('.context-btn').forEach(btn => {
          btn.classList.remove('bg-purple-600', 'text-white', 'border-purple-600');
          btn.classList.add('bg-gray-700', 'text-gray-300', 'border-gray-600');
        });
        
        e.target.classList.remove('bg-gray-700', 'text-gray-300', 'border-gray-600');
        e.target.classList.add('bg-purple-600', 'text-white', 'border-purple-600');
        
        aiContext = e.target.dataset.context;
        
        const contextDescriptions = {
          current: 'AI will have access to the entry you\'re currently reading',
          all: 'AI will have an overview of all entries in the collection',
          none: 'AI will respond without specific context about your texts'
        };
        contextInfo.textContent = contextDescriptions[aiContext];
      }
    });

    document.addEventListener('keydown', (e) => {
      if (document.activeElement === searchBox || document.activeElement === aiInput) return;

      if (e.key === 'ArrowLeft') {
        e.preventDefault();
        navigateEntries('prev');
      }
      if (e.key === 'ArrowRight') {
        e.preventDefault();
        navigateEntries('next');
      }
      if (e.key === 'Home') {
        e.preventDefault();
        let targetId;
        let currentViewableItems = isSearching ? searchResults : getFilteredEntries().map(e => ({entry: e, id: e.id}));
        if (currentViewableItems.length > 0) {
          targetId = currentViewableItems[0].id;
        } else {
          targetId = -1;
        }
        showEntry(targetId);
      }
      if (e.key === 'End') {
        e.preventDefault();
        let targetId;
        let currentViewableItems = isSearching ? searchResults : getFilteredEntries().map(e => ({entry: e, id: e.id}));
        if (currentViewableItems.length > 0) {
          targetId = currentViewableItems[currentViewableItems.length - 1].id;
        } else {
          targetId = -1;
        }
        showEntry(targetId);
      }
      if (e.key === 'r' || e.key === 'R') {
        e.preventDefault();
        showRandomEntry();
      }
      if (e.key === '/') {
        e.preventDefault();
        searchBox.focus();
      }
    });
  </script>
</body>
</html>
