<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>b/R-im reader</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Nova+Mono&family=Special+Elite&display=swap" rel="stylesheet">
         <style>
/* === DEFINE VARIABLES FIRST === */
:root {
    --red: #ff0033;
    --black: #0a0a0a;
}

/* === NOW selection can use them === */
::selection {
    background: var(--red);
    color: var(--black);
    text-shadow: none;
}
</style>
  <style>
    :root { 
      --red: #ff0000; 
      --black: #050505; 
      --dark-grey: #121212; 
      --white: #d1d1d1; 
    }
    
    * {
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: 'Nova Mono', monospace;
      background: var(--black);
      color: var(--white);
      margin: 0;
      touch-action: manipulation;
    }
    
    /* CRT Scanline Overlay */
    body::after {
      content: " "; 
      display: block; 
      position: fixed; 
      top: 0; 
      left: 0; 
      bottom: 0; 
      right: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.15) 50%), 
                  linear-gradient(90deg, rgba(255, 0, 0, 0.04), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.04));
      z-index: 999; 
      background-size: 100% 3px, 3px 100%; 
      pointer-events: none;
    }
    
    .highlight {
      background-color: var(--red);
      color: var(--black);
      padding: 1px 3px;
      border-radius: 0;
    }
    
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: var(--black);
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background-color: var(--red);
      border-radius: 3px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background-color: #cc0000;
    }
    
    input, textarea, select {
      font-family: 'Nova Mono', monospace;
    }
    
    button {
      font-family: 'Nova Mono', monospace;
      user-select: none;
      cursor: pointer;
    }
    
    .special-elite {
      font-family: 'Special Elite', serif;
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-300 antialiased p-4 sm:p-6 md:p-8" style="background: var(--black); color: var(--white);">
  <div class="max-w-4xl mx-auto">
    <div id="controls" class="sticky top-0 pt-4 pb-6 border-b z-10" style="background: var(--black); border-color: var(--red);">
      <h1 class="text-3xl font-bold mb-4" style="color: var(--red); font-family: 'Special Elite', serif;">⚡ b/R-im reader ⚡</h1>
      <a href="https://inkrealm.info" 
         class="absolute top-6 right-4 sm:right-8 text-xs font-mono border px-2 py-1 hover:bg-red-600 transition-all duration-300 uppercase tracking-widest no-underline z-50"
         style="color: #666; border-color: #333;">
        Return to Realm
      </a>
      
      <!-- SEARCH CONTROLS -->
      <input
        type="text"
        id="searchBox"
        class="w-full border p-2 text-sm focus:outline-none transition-all duration-300 mb-2"
        style="background: var(--dark-grey); border-color: #222; color: var(--white); font-size: 16px;"
        placeholder="Search: inky AND korea, doan OR siti, brim -politics"
      />
      <div id="searchStats" class="text-xs min-h-[14px] mb-4" style="color: #666;"></div>

      <div class="flex flex-wrap items-center justify-center sm:justify-start gap-2 mb-4">
        <button id="prevBtn" class="bg-transparent border py-2 px-4 text-sm transition-colors duration-300" style="border-color: var(--red); color: var(--red);">← Previous</button>
        <button id="nextBtn" class="bg-transparent border py-2 px-4 text-sm transition-colors duration-300" style="border-color: var(--red); color: var(--red);">Next →</button>
        <button id="randomBtn" class="bg-transparent border py-2 px-4 text-sm transition-colors duration-300" style="border-color: var(--red); color: var(--red);">⚡---⚡</button>
        <button id="indexBtn" class="bg-transparent border py-2 px-4 text-sm transition-colors duration-300" style="border-color: var(--red); color: var(--red);">BRIM Index</button>
      </div>

      <div id="filterBtns" class="flex flex-wrap items-center justify-center sm:justify-start gap-2 mb-4">
        <button class="filter-btn bg-transparent border py-1 px-3 text-xs transition-colors duration-300" style="border-color: #333; color: #666;" data-filter="all">All</button>
        <button class="filter-btn bg-transparent border py-1 px-3 text-xs transition-colors duration-300" style="border-color: var(--red); color: var(--red);" data-filter="fragments">Fragments</button>
        <button class="filter-btn bg-transparent border py-1 px-3 text-xs transition-colors duration-300" style="border-color: #cc0000; color: #cc0000;" data-filter="passages">Passages</button>
        <button class="filter-btn bg-transparent border py-1 px-3 text-xs transition-colors duration-300" style="border-color: #ff3333; color: #ff3333;" data-filter="sections">Sections</button>
        <button class="filter-btn bg-transparent border py-1 px-3 text-xs transition-colors duration-300" style="border-color: #ff6666; color: #ff6666;" data-filter="sketches">Sketches</button>
      </div>

      <div id="dateNav" class="mt-4 max-h-80 overflow-y-auto border p-2 transition-all duration-300 hidden custom-scrollbar" style="border-color: #222;"></div>
      
      <!-- NVIDIA AI SECTION -->
      <div class="mt-8 pt-6 border-t" style="border-color: #222;">
        <h2 class="text-2xl font-bold mb-4 special-elite" style="color: var(--red);">Nvidia Link</h2>
        
        <!-- API KEY INPUT -->
        <div class="mb-4">
            <input type="password" id="apiKeyInput" 
                class="w-full border p-2 text-xs focus:outline-none transition-all duration-300" 
                style="background: #000; border-color: #333; color: var(--red); font-family: monospace;" 
                placeholder="Paste NVIDIA API Key here (nvapi-...)"
            >
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium mb-2" style="color: #666;">Context:</label>
          <div class="flex flex-wrap gap-2">
            <button class="context-btn border py-1 px-3 text-xs transition-colors duration-300" style="background: var(--red); border-color: var(--red); color: var(--black);" data-context="current">Current BRIM</button>
            <button class="context-btn border py-1 px-3 text-xs transition-colors duration-300" style="background: var(--dark-grey); border-color: #333; color: #888;" data-context="all">All BRIMs</button>
            <button class="context-btn border py-1 px-3 text-xs transition-colors duration-300" style="background: var(--dark-grey); border-color: #333; color: #888;" data-context="none">No Context</button>
          </div>
          <p class="text-xs mt-1" id="contextInfo" style="color: #555;">AI has access to current text.</p>
        </div>
        
        <div class="mb-4">
          <textarea id="aiInput" class="w-full border p-2 text-sm focus:outline-none transition-all duration-300 min-h-[80px]" style="background: var(--dark-grey); border-color: #222; color: var(--white); font-size: 16px;" placeholder="Ask about themes, continuity, or edits..." aria-label="AI input"></textarea>
        </div>
        <button id="askAiBtn" class="py-2 px-6 text-sm transition-colors duration-300 font-bold" style="background: var(--red); color: var(--black);">TRANSMIT TO NVIDIA</button>
        
        <div class="mb-4 mt-6">
          <div id="aiResponse" class="w-full border p-3 text-sm min-h-[120px] max-h-[500px] overflow-y-auto custom-scrollbar whitespace-pre-wrap special-elite" style="background: var(--dark-grey); border-color: #222; color: var(--white);">
            <p class="italic" style="color: #555;">:: System Standby ::</p>
          </div>
        </div>
      </div>

      <div id="entryInfo" class="text-xs mt-4 mb-4" style="color: #666;"></div>
    </div>

    <div id="loading" class="text-center py-12 text-lg" style="color: var(--red);">Loading brim.txt...</div>
    <div id="content" class="text-sm leading-relaxed whitespace-pre-wrap special-elite" style="display:none;"></div>
  </div>

<script>
    // ==========================================
    // 1. CONFIGURATION & STATE
    // ==========================================
    const TXT_FILE_URL = 'brim.txt';
    
    // Nvidia Models (Stable Llama 3.3 as primary)
    const NVIDIA_MODELS = {
        "stable": "meta/llama-3.3-70b-instruct", 
        "backup": "nvidia/llama-3.1-nemotron-70b-instruct",
    };
    let currentModel = NVIDIA_MODELS.stable;

    // Reader State
    let entries = [];
    let currentIndex = 0;
    let currentFilter = 'all';
    let searchQuery = '';
    let searchResults = [];
    let isSearching = false;
    let isIndexVisible = false;
    let aiContext = 'current';
    let searchTimeout = null;

    // Regex Patterns
    const TAG_PATTERNS = {
      all: /.*/,
      fragments: /\[fragment\]|\bfragment(s)?\b/i,
      passages: /\[passage\]|\bpassage(s)?\b/i,
      sections: /\[section\]|\bsection(s)?\b/i,
      sketches: /\[sketch\]|\bsketch(es)?\b/i,
      vignettes: /\[vignette\]|\bvignette(s)?\b/i
    };
    const brimPattern = /^(\d+\s*(?:0r|\/)\s*\d+\s*\.{0,4}\s*(?:BRIM|brim)|(?:BRIM|brim)\s+\d+)/im;

    // ==========================================
    // 2. DOM ELEMENTS
    // ==========================================
    const searchBox = document.getElementById('searchBox');
    const searchStats = document.getElementById('searchStats');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const randomBtn = document.getElementById('randomBtn');
    const indexBtn = document.getElementById('indexBtn');
    const dateNav = document.getElementById('dateNav');
    const entryInfo = document.getElementById('entryInfo');
    const loadingDiv = document.getElementById('loading');
    const contentDiv = document.getElementById('content');
    const filterBtns = document.getElementById('filterBtns');
    
    // AI Elements
    const apiKeyInput = document.getElementById('apiKeyInput');
    const aiInput = document.getElementById('aiInput');
    const askAiBtn = document.getElementById('askAiBtn');
    const aiResponseDiv = document.getElementById('aiResponse');
    const contextInfo = document.getElementById('contextInfo');

    // ==========================================
    // 3. AI LOGIC (NVIDIA + DREAM PROMPT)
    // ==========================================
    
    // Load API Key from storage
    if(localStorage.getItem('brim_nvidia_key')) {
        apiKeyInput.value = localStorage.getItem('brim_nvidia_key');
    }
    apiKeyInput.addEventListener('input', (e) => localStorage.setItem('brim_nvidia_key', e.target.value));

    async function handleAskAI() {
        const apiKey = apiKeyInput.value.trim();
        const msg = aiInput.value.trim();

        if (!apiKey) {
            aiResponseDiv.innerHTML = `<p style="color: var(--red);">❌ Please enter your NVIDIA API Key.</p>`;
            return;
        }
        if (!msg) return;

        askAiBtn.disabled = true;
        askAiBtn.textContent = "TRANSMITTING...";
        aiResponseDiv.innerHTML = `<p class="animate-pulse" style="color: var(--red);">Consulting the Machine (${currentModel.split('/')[1]})...</p>`;

        try {
            const systemContext = buildAIPrompt(""); 
            const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent('https://integrate.api.nvidia.com/v1/chat/completions');
            
            const response = await fetch(proxyUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: currentModel,
                    messages: [
                        { 
                          role: "system", 
                          content: "You are an editor for BRIM, a narrative where the lines between reality and dreams are intentionally blurred. Interpret the text through the lens of subconscious symbolism and surrealism. Do not try to force logical continuity if the surrealism serves the narrative. Be bold, concise, and atmospheric." 
                        },
                        { role: "user", content: systemContext + "\n\nUser Question: " + msg }
                    ],
                    temperature: 0.6,
                    top_p: 1,
                    max_tokens: 1024,
                    stream: false
                })
            });

            if (!response.ok) {
                const errText = await response.text();
                if (response.status === 404) {
                    throw new Error(`Model 404. Switching to backup...`);
                }
                throw new Error(`API Error (${response.status}): ${errText}`);
            }

            const data = await response.json();
            const reply = data.choices[0].message.content;
            aiResponseDiv.textContent = reply;

        } catch (error) {
            console.error(error);
            aiResponseDiv.innerHTML = `<p style="color: var(--red);">Error: ${error.message}</p>`;
            
            // Auto-fallback logic
            if(error.message.includes("404") || error.message.includes("Switching")) {
                currentModel = NVIDIA_MODELS.backup;
                aiResponseDiv.innerHTML += `<p class="text-xs mt-2" style="color: #666;">⚠️ Llama 3.3 unavailable. Switched to Nemotron 70B. Please click Transmit again.</p>`;
            }
        } finally {
            askAiBtn.disabled = false;
            askAiBtn.textContent = "TRANSMIT TO NVIDIA";
        }
    }

    function buildAIPrompt(userMessage) {
      let systemContext = '';
      if (aiContext === 'current' && currentIndex !== 0) {
        const entry = entries.find(e => e.id === currentIndex);
        if (entry) {
            const safeContent = entry.content.substring(0, 3500); 
            systemContext = `CONTEXT (Current BRIM Section - ${entry.title}):\n${safeContent}\n\n---\n`;
        }
      } else if (aiContext === 'all') {
        const list = entries.map(e => `- ${e.title}`).join('\n');
        systemContext = `CONTEXT (BRIM Outline):\n${list}\n\n---\n`;
      }
      return systemContext + userMessage;
    }

    // ==========================================
    // 4. READER LOGIC (Parsing & Nav)
    // ==========================================

    function debounce(func, delay) {
      return function(...args) {
        if (searchTimeout) clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    function escapeRegex(str) { return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

    function getTagClass(tag) {
      switch (tag) {
        case 'fragments': return 'border-red-600 text-red-600';
        case 'passages': return 'border-red-700 text-red-700';
        case 'sections': return 'border-red-500 text-red-500';
        case 'sketches': return 'border-red-400 text-red-400';
        case 'vignettes': return 'border-red-300 text-red-300';
        default: return 'border-gray-600 text-gray-600';
      }
    }

    async function loadText() {
      try {
        const response = await fetch(TXT_FILE_URL);
        if (!response.ok) throw new Error("File not found");
        const text = await response.text();
        parseEntries(text);
        loadingDiv.style.display = 'none';
        contentDiv.style.display = 'block';
        if (entries.length > 0) showEntry(entries[0].id);
        
        // Highlight "All" filter by default
        const allBtn = document.querySelector('.filter-btn[data-filter="all"]');
        if(allBtn) {
            allBtn.style.background = 'var(--red)';
            allBtn.style.color = 'var(--black)';
            allBtn.style.borderColor = 'var(--red)';
        }
        buildIndex();
      } catch (error) {
        loadingDiv.innerHTML = `<p style="color: var(--red);">Error loading brim.txt. Ensure the file exists.</p>`;
      }
    }

    function parseEntries(text) {
      const lines = text.split('\n');
      let currentEntry = { id: 0, title: 'Start', content: '', tags: [] };
      let entryId = 0;
      lines.forEach(line => {
        const match = line.match(brimPattern);
        if (match) {
          if (currentEntry.content.trim()) { detectTags(currentEntry); entries.push(currentEntry); }
          currentEntry = { id: ++entryId, title: match[0].trim(), content: line + '\n', tags: [] };
        } else { currentEntry.content += line + '\n'; }
      });
      if (currentEntry.content.trim()) { detectTags(currentEntry); entries.push(currentEntry); }
    }

    function detectTags(entry) {
      for (const [tag, pattern] of Object.entries(TAG_PATTERNS)) {
        if (tag !== 'all' && pattern.test(entry.content)) entry.tags.push(tag);
      }
    }

    function getFilteredEntries() {
      if (currentFilter === 'all') return entries;
      return entries.filter(e => e.tags.includes(currentFilter));
    }

    // ==========================================
    // 5. SEARCH LOGIC
    // ==========================================

    function parseSearchQuery(query) {
      const terms = { and: [], or: [], not: [], exact: [] };
      const exactMatches = query.match(/"([^"]+)"/g);
      if (exactMatches) {
        exactMatches.forEach(match => {
          terms.exact.push(match.replace(/"/g, '').toLowerCase());
          query = query.replace(match, '');
        });
      }
      const words = query.toLowerCase().split(/\s+/).filter(w => w);
      let currentOp = 'and';
      words.forEach(word => {
        if (word === 'and') currentOp = 'and';
        else if (word === 'or') currentOp = 'or';
        else if (word.startsWith('-')) terms.not.push(word.substring(1));
        else if (word) terms[currentOp].push(word);
      });
      return terms;
    }

    function matchesSearch(entry, terms) {
      const searchText = (entry.content + ' ' + entry.title).toLowerCase();
      if (terms.not.some(t => searchText.includes(t))) return false;
      if (terms.exact.some(t => !searchText.includes(t))) return false;
      if (terms.and.some(t => !searchText.includes(t))) return false;
      if (terms.or.length > 0 && !terms.or.some(t => searchText.includes(t))) return false;
      return true;
    }

    function performSearch(query) {
      searchQuery = query;
      if (!query.trim()) {
        isSearching = false;
        searchResults = [];
        updateSearchStats();
        buildIndex();
        const filtered = getFilteredEntries();
        if (filtered.length > 0) showEntry(filtered[0].id);
        return;
      }
      isSearching = true;
      const terms = parseSearchQuery(query);
      searchResults = getFilteredEntries().filter(e => matchesSearch(e, terms));
      updateSearchStats();
      buildIndex();
      if (searchResults.length > 0) showEntry(searchResults[0].id);
    }

    function updateSearchStats() {
      if (isSearching) searchStats.textContent = `${searchResults.length} matches`;
      else {
        const filtered = getFilteredEntries();
        searchStats.textContent = currentFilter !== 'all' ? `${filtered.length} entries tagged '${currentFilter}'` : '';
      }
    }

    function highlightText(text, query) {
      if (!query.trim()) return text;
      const terms = parseSearchQuery(query);
      const allTerms = [...terms.exact, ...terms.and, ...terms.or].filter((t, i, s) => s.indexOf(t) === i);
      let result = text;
      allTerms.sort((a, b) => b.length - a.length).forEach(term => {
        const regex = new RegExp(`(${escapeRegex(term)})`, 'gi');
        result = result.replace(regex, '<span class="highlight" style="background:var(--red); color:black;">$1</span>');
      });
      return result;
    }

    // ==========================================
    // 6. DISPLAY & NAVIGATION
    // ==========================================

    function showEntry(entryId) {
      if (entries.length === 0) return;
      const entry = entries.find(e => e.id === entryId);
      if (!entry) return;
      
      currentIndex = entryId;
      const displayContent = isSearching && searchQuery.trim() ? highlightText(entry.content, searchQuery) : entry.content;
      contentDiv.innerHTML = displayContent;

      const viewableItems = isSearching ? searchResults : getFilteredEntries();
      const itemIndex = viewableItems.findIndex(e => e.id === currentIndex);
      const resultInfo = isSearching ? ` • Result ${itemIndex + 1} of ${searchResults.length}` : '';
      const filterInfo = currentFilter !== 'all' ? ` (${currentFilter})` : '';
      const wordCount = entry.content.split(/\s+/).length;

      entryInfo.innerHTML = `BRIM: <span class="font-bold" style="color: var(--red);">${entry.title}</span>${resultInfo}${filterInfo} <span style="color: #444;">• ${wordCount} words</span>
        <div class="inline-flex ml-2">${entry.tags.map(tag => `<span class="inline-block px-2 py-0.5 ml-1 text-xs rounded-sm border ${getTagClass(tag)}">${tag}</span>`).join('')}</div>`;

      prevBtn.disabled = itemIndex <= 0;
      nextBtn.disabled = itemIndex >= viewableItems.length - 1;
      window.scrollTo({ top: 0, behavior: 'smooth' });
      updateSearchStats();
    }

    function buildIndex() {
      dateNav.innerHTML = '';
      const items = isSearching ? searchResults : getFilteredEntries();
      if (items.length === 0) { dateNav.innerHTML = '<p class="text-sm p-2" style="color: #555;">No entries found.</p>'; return; }
      items.forEach(entry => {
        const div = document.createElement('div');
        div.className = 'group block p-2 cursor-pointer border-b last:border-b-0 transition-colors duration-200';
        div.style.borderColor = '#111';
        const preview = entry.content.replace(/\n/g, ' ').substring(0, 100).trim();
        div.innerHTML = `<div class="flex items-center text-sm font-bold" style="color: var(--red);">${entry.title}</div><div class="text-xs mt-1 italic" style="color: #555;">${preview}...</div>`;
        div.addEventListener('click', () => { showEntry(entry.id); dateNav.classList.add('hidden'); isIndexVisible = false; });
        div.addEventListener('mouseover', () => div.style.background = '#0a0a0a');
        div.addEventListener('mouseout', () => div.style.background = 'transparent');
        dateNav.appendChild(div);
      });
    }

    function showRandomEntry() {
      const pool = isSearching ? searchResults : getFilteredEntries();
      if (pool.length > 0) { const random = pool[Math.floor(Math.random() * pool.length)]; showEntry(random.id); }
    }

    function navigateEntries(direction) {
      const items = isSearching ? searchResults : getFilteredEntries();
      if (items.length === 0) return;
      const idx = items.findIndex(e => e.id === currentIndex);
      const newIdx = direction === 'next' ? Math.min(idx + 1, items.length - 1) : Math.max(idx - 1, 0);
      if (newIdx !== idx) showEntry(items[newIdx].id);
    }

    // ==========================================
    // 7. EVENT LISTENERS
    // ==========================================
    
    // Initialize
    document.addEventListener('DOMContentLoaded', loadText);
    
    // AI
    askAiBtn.addEventListener('click', handleAskAI);

    // Search
    searchBox.addEventListener('input', debounce(e => performSearch(e.target.value), 300));
    searchBox.addEventListener('focus', e => e.target.style.borderColor = 'var(--red)');
    searchBox.addEventListener('blur', e => e.target.style.borderColor = '#222');

    // Navigation
    prevBtn.addEventListener('click', () => navigateEntries('prev'));
    nextBtn.addEventListener('click', () => navigateEntries('next'));
    randomBtn.addEventListener('click', showRandomEntry);
    indexBtn.addEventListener('click', () => { isIndexVisible = !isIndexVisible; dateNav.classList.toggle('hidden'); if (isIndexVisible) buildIndex(); });

    // Filter Buttons
    filterBtns.addEventListener('click', e => {
      if (e.target.classList.contains('filter-btn')) {
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.style.borderColor = btn.dataset.filter === 'all' ? '#333' : getTagClass(btn.dataset.filter).split(' ')[0].replace('border-', '');
            btn.style.color = btn.dataset.filter === 'all' ? '#666' : getTagClass(btn.dataset.filter).split(' ')[1].replace('text-', '');
            btn.style.background = 'transparent';
        });
        e.target.style.background = 'var(--red)';
        e.target.style.color = 'var(--black)';
        e.target.style.borderColor = 'var(--red)';
        currentFilter = e.target.dataset.filter;
        if (isSearching) performSearch(searchQuery);
        else { const filtered = getFilteredEntries(); if (filtered.length > 0) showEntry(filtered[0].id); buildIndex(); }
      }
    });

    // Context Toggles
    document.addEventListener('click', e => {
      if (e.target.classList.contains('context-btn')) {
        document.querySelectorAll('.context-btn').forEach(btn => {
          btn.style.background = 'var(--dark-grey)';
          btn.style.color = '#888';
          btn.style.borderColor = '#333';
        });
        e.target.style.background = 'var(--red)';
        e.target.style.color = 'var(--black)';
        e.target.style.borderColor = 'var(--red)';
        aiContext = e.target.dataset.context;
        contextInfo.textContent = aiContext === 'current' ? 'AI has access to current text.' : (aiContext === 'all' ? 'AI sees BRIM outline.' : 'AI responds without context.');
      }
    });

    // Shortcuts
    document.addEventListener('keydown', e => {
      if (document.activeElement === searchBox || document.activeElement === aiInput || document.activeElement === apiKeyInput) return;
      if (e.key === 'ArrowLeft') { e.preventDefault(); navigateEntries('prev'); }
      if (e.key === 'ArrowRight') { e.preventDefault(); navigateEntries('next'); }
      if (e.key === 'r' || e.key === 'R') { e.preventDefault(); showRandomEntry(); }
      if (e.key === '/') { e.preventDefault(); searchBox.focus(); }
    });

    // Hover Effects
    document.addEventListener('mouseover', e => {
      if (e.target.matches('button:not(:disabled)') && !e.target.classList.contains('context-btn') && !e.target.classList.contains('filter-btn')) {
        e.target.style.background = 'var(--red)';
        e.target.style.color = 'var(--black)';
      }
    });
    document.addEventListener('mouseout', e => {
        if (e.target.matches('button:not(:disabled)') && !e.target.classList.contains('context-btn') && !e.target.classList.contains('filter-btn') && e.target.id !== 'askAiBtn') {
            e.target.style.background = 'transparent';
            e.target.style.color = 'var(--red)';
        }
    });
  </script>
</body>
</html>
