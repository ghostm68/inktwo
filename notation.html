<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/smufl-fonts/1.39.0/fonts/bravura.css">
    <style>
        .music {
            font-family: 'Bravura', sans-serif;
        }
    </style>
    <title>SymphonySketch</title>
   
    <style>
        body {
            font-family: Arial, sans-serif, Bravura;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #1a1a1a;
            color: #f0f0f0;
            padding: 20px;
        }
        #staff-container {
            width: 1200px;
            height: 600px;
            background-color: #333;
            border: 1px solid #f0f0f0;
            margin: 20px 0;
            position: relative;
            overflow-x: auto;
            overflow-y: hidden;
        }
        .staff {
            width: 3600px;
            height: 50%;
            position: relative;
        }
        #treble-staff {
            position: absolute;
            top: 0;
        }
        #bass-staff {
            position: absolute;
            bottom: 0;
        }
        .staff-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background-color: #f0f0f0;
        }
        .clef, .bass-clef {
            position: absolute;
            left: 10px;
            top: 60px;
            font-size: 120px;
            color: #f0f0f0;
        }
        .note {
            width: 40px;
            height: 40px;
            position: absolute;
            cursor: pointer;
        }
        .note:hover {
            filter: brightness(0.8);
        }
        .note.deletable {
            outline: 2px solid red;
        }
        #controls, #note-controls, #playback-controls {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        button {
            font-size: 16px;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: white;
            color: #1a1a1a;
        }
        button:hover {
            background-color: #45a049;
        }
        #clear {
            background-color: #ff6b6b;
        }
        #clear:hover {
            background-color: #ff4757;
        }
        .accidental {
            font-size: 32px;
            position: absolute;
            cursor: pointer;
        }
        #tempo {
            font-size: 16px;
            padding: 5px;
            margin: 5px;
            background-color: #333;
            color: #f0f0f0;
            border: 1px solid #f0f0f0;
        }
        #delete-mode {
            background-color: red;
        }
        #delete-mode:hover {
            background-color: grey;
        }
        #delete-mode.active {
            background-color: pink;
        }
        #playback-arrow {
            position: absolute;
            top: -30px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 20px solid red;
            transition: left 0.1s linear;
        }
        .note span {
            position: absolute;
            left: 0;
            top: -10px;
            color: #f0f0f0;
        }
    </style>
</head>
<body>
    <h1>SymphonySketch</h1>
    <div id="controls">
        <button id="whole">Whole</button>
        <button id="half">Half</button>
        <button id="quarter">Quarter</button>
        <button id="eighth">Eighth</button>
        <button id="sixteenth">Sixteenth</button>
    </div>
    <div id="note-controls">
        <button id="natural">Natural</button>
        <button id="sharp">Sharp (♯)</button>
        <button id="flat">Flat (♭)</button>
    </div>
    <div id="playback-controls">
        <button id="play" disabled>Play Sketch</button>
        <button id="clear">Clear Staff</button>
        <button id="delete-mode">Delete Mode</button>
        <label for="tempo">Tempo (BPM):</label>
        <input type="number" id="tempo" min="40" max="240" value="120">
        <span id="loading-indicator" style="display: none;">Loading piano sound...</span>
    </div>
    <div id="staff-container">
        <div id="treble-staff" class="staff"></div>
        <div id="bass-staff" class="staff"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <script>
        const trebleStaff = document.getElementById('treble-staff');
        const bassStaff = document.getElementById('bass-staff');
        const trebleNotes = ['F5', 'E5', 'D5', 'C5', 'B4', 'A4', 'G4', 'F4', 'E4', 'D4', 'C4'];
        const bassNotes = ['A3', 'G3', 'F3', 'E3', 'D3', 'C3', 'B2', 'A2', 'G2', 'F2', 'E2'];
        let selectedNote = 'quarter';
        let selectedAccidental = 'natural';
        let melody = [];
        let deleteMode = false;

        const noteSymbols = {
            'whole': '\uE1D2',
            'half': '\uE1D3',
            'quarter': '\uE1D5',
            'eighth': '\uE1D7',
            'sixteenth': '\uE1D9'
        };

        function createStaffLines(staff) {
            for (let i = 0; i < 5; i++) {
                const line = document.createElement('div');
                line.className = 'staff-line';
                line.style.top = `${80 + i * 40}px`;
                staff.appendChild(line);
            }
        }

        function addClef(staff, clefType) {
            const clef = document.createElement('div');
            clef.className = clefType === 'treble' ? 'clef' : 'bass-clef';
            clef.innerHTML = clefType === 'treble' ? '\uE050' : '\uE062';
            staff.appendChild(clef);
        }

        createStaffLines(trebleStaff);
        createStaffLines(bassStaff);
        addClef(trebleStaff, 'treble');
        addClef(bassStaff, 'bass');

        function addNote(x, noteIndex, staff) {
            const note = document.createElement('div');
            note.className = 'note';
            note.style.left = `${x - 20}px`;
            note.style.top = `${noteIndex * 20 + 60}px`;

            const noteSymbol = document.createElement('span');
            noteSymbol.textContent = noteSymbols[selectedNote];
            note.appendChild(noteSymbol);

            if (selectedAccidental !== 'natural') {
                const accidental = document.createElement('div');
                accidental.className = 'accidental';
                accidental.style.left = '-25px';
                accidental.style.top = '-15px';
                accidental.textContent = selectedAccidental === 'sharp' ? '\uE262' : '\uE260';
                note.appendChild(accidental);
            }

            staff.appendChild(note);

            let noteName = staff === trebleStaff ? trebleNotes[noteIndex] : bassNotes[noteIndex];
            if (selectedAccidental === 'sharp') {
                noteName += '#';
            } else if (selectedAccidental === 'flat') {
                noteName = noteName.charAt(0) + 'b' + noteName.charAt(1);
            }

            melody.push({ note: noteName, duration: selectedNote, x: x, element: note, staff: staff.id });
        }

        trebleStaff.addEventListener('click', (e) => handleStaffClick(e, trebleStaff));
        bassStaff.addEventListener('click', (e) => handleStaffClick(e, bassStaff));

        function handleStaffClick(e, staff) {
            const rect = staff.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const noteIndex = Math.floor((y - 60) / 20);

            if (deleteMode) {
                const note = document.elementFromPoint(e.clientX, e.clientY);
                if (note && note.classList.contains('note')) {
                    note.remove();
                    melody = melody.filter(item => item.element !== note);
                }
            } else {
                if (noteIndex >= 0 && noteIndex < trebleNotes.length) {
                    addNote(x, noteIndex, staff);
                }
            }
        }

        document.getElementById('whole').addEventListener('click', () => selectNoteType('whole'));
        document.getElementById('half').addEventListener('click', () => selectNoteType('half'));
        document.getElementById('quarter').addEventListener('click', () => selectNoteType('quarter'));
        document.getElementById('eighth').addEventListener('click', () => selectNoteType('eighth'));
        document.getElementById('sixteenth').addEventListener('click', () => selectNoteType('sixteenth'));
        document.getElementById('natural').addEventListener('click', () => selectAccidental('natural'));
        document.getElementById('sharp').addEventListener('click', () => selectAccidental('sharp'));
        document.getElementById('flat').addEventListener('click', () => selectAccidental('flat'));

        function selectNoteType(noteType) {
            selectedNote = noteType;
        }

        function selectAccidental(accidental) {
            selectedAccidental = accidental;
        }

        const synth = new Tone.Synth().toDestination();
        let pianoLoaded = false;

        async function loadPiano() {
            document.getElementById('loading-indicator').style.display = 'block';
            const piano = await new Tone.Sampler({
                urls: {
                    A0: "A0.mp3",
                    C1: "C1.mp3",
                    "D#1": "Ds1.mp3",
                    "F#1": "Fs1.mp3",
                    A1: "A1.mp3",
                    C2: "C2.mp3",
                    "D#2": "Ds2.mp3",
                    "F#2": "Fs2.mp3",
                    A2: "A2.mp3",
                    C3: "C3.mp3",
                    "D#3": "Ds3.mp3",
                    "F#3": "Fs3.mp3",
                    A3: "A3.mp3",
                    C4: "C4.mp3",
                    "D#4": "Ds4.mp3",
                    "F#4": "Fs4.mp3",
                    A4: "A4.mp3",
                    C5: "C5.mp3",
                    "D#5": "Ds5.mp3",
                    "F#5": "Fs5.mp3",
                    A5: "A5.mp3",
                    C6: "C6.mp3",
                    "D#6": "Ds6.mp3",
                    "F#6": "Fs6.mp3",
                    A6: "A6.mp3",
                    C7: "C7.mp3",
                    "D#7": "Ds7.mp3",
                    "F#7": "Fs7.mp3",
                    A7: "A7.mp3",
                    C8: "C8.mp3"
                },
                release: 1,
                baseUrl: "https://tonejs.github.io/audio/salamander/"
            }).toDestination();
            document.getElementById('loading-indicator').style.display = 'none';
            document.getElementById('play').disabled = false;
            pianoLoaded = true;
            return piano;
        }

        let piano;
        document.getElementById('play').addEventListener('click', async () => {
            if (!pianoLoaded) {
                piano = await loadPiano();
            }
            playMelody();
        });

        function playMelody() {
            let time = Tone.now();
            const tempo = Number(document.getElementById('tempo').value);
            const durationMap = {
                whole: '1n',
                half: '2n',
                quarter: '4n',
                eighth: '8n',
                sixteenth: '16n'
            };

            const playbackArrow = document.createElement('div');
            playbackArrow.id = 'playback-arrow';
            trebleStaff.appendChild(playbackArrow);

            melody.forEach((note, index) => {
                setTimeout(() => {
                    piano.triggerAttackRelease(note.note, durationMap[note.duration], time);
                    playbackArrow.style.left = `${note.x}px`;
                    playbackArrow.style.top = note.staff === 'treble-staff' ? '10px' : '220px';
                }, (60 / tempo) * 1000 * index);
                time += Tone.Time(durationMap[note.duration]).toSeconds();
            });

            setTimeout(() => {
                playbackArrow.remove();
            }, melody.length * (60 / tempo) * 1000);
        }

        document.getElementById('clear').addEventListener('click', () => {
            trebleStaff.innerHTML = '';
            bassStaff.innerHTML = '';
            melody = [];
            createStaffLines(trebleStaff);
            createStaffLines(bassStaff);
            addClef(trebleStaff, 'treble');
            addClef(bassStaff, 'bass');
        });

        document.getElementById('delete-mode').addEventListener('click', () => {
            deleteMode = !deleteMode;
            document.getElementById('delete-mode').classList.toggle('active', deleteMode);
        });
    </script>
</body>
</html>
