<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>InkRealm SVG - Marx Bros Edition</title>
  <style>
    :root{--bg-primary:#ffffff;--bg-secondary:#f5f5f5;--bg-tertiary:#e0e0e0;--text-primary:#000000;--text-secondary:#666666;--border-color:#cccccc;--accent:#000000}
    [data-theme="dark"]{--bg-primary:#1a1a1a;--bg-secondary:#2a2a2a;--bg-tertiary:#3a3a3a;--text-primary:#ffffff;--text-secondary:#aaaaaa;--border-color:#444444;--accent:#ffffff}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg-primary);color:var(--text-primary);overflow:hidden}
    .app-container{display:flex;flex-direction:column;height:100vh}
    .toolbar{background:var(--bg-secondary);border-bottom:1px solid var(--border-color);padding:.5rem 1rem;display:flex;justify-content:space-between;align-items:center}
    .logo h1{font-size:1.25rem;font-weight:600}
    .toolbar-actions{display:flex;gap:.5rem;align-items:center}
    .btn{background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:.5rem 1rem;border-radius:4px;cursor:pointer;font-size:.875rem}
    .btn:hover{background:var(--accent);color:var(--bg-primary)}
    .btn-icon{padding:.5rem;display:flex;align-items:center;justify-content:center}
    .workspace{display:flex;flex:1;overflow:hidden}
    .tools-panel{width:280px;background:var(--bg-secondary);border-right:1px solid var(--border-color);padding:1rem;overflow-y:auto}
    .tool-group{margin-bottom:2rem}
    .tool-buttons{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem}
    .tool-btn{background:var(--bg-primary);border:1px solid var(--border-color);color:var(--text-primary);padding:1rem;border-radius:4px;cursor:pointer}
    .tool-btn:hover{border-color:var(--accent)}
    .tool-btn.active{background:var(--accent);color:var(--bg-primary)}
    .canvas-container{flex:1;display:flex;align-items:center;justify-content:center;background:var(--bg-primary);position:relative}
    #main-canvas{background:var(--bg-primary);border:1px solid var(--border-color);box-shadow:0 4px 12px rgba(0,0,0,.08);cursor:crosshair}
    
    /* The Box that was missing! */
    .dialog{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:9999}
    .dialog.active{display:flex}
    .dialog-content{background:var(--bg-primary);padding:2rem;border-radius:8px;display:flex;flex-direction:column;gap:1rem;min-width:300px; box-shadow:0 10px 25px rgba(0,0,0,0.5);}
    
    /* Help Panel */
    #helpPanel { position: fixed; top:0; right:0; width:300px; height:100%; background:#111; color:#fff; padding:20px; transform: translateX(100%); transition: transform 0.3s ease; z-index:10000; overflow-y:auto; }
    #helpPanel.open { transform: translateX(0); }
    .selected { stroke-dasharray: 5,5; stroke: #ff00ff !important; }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="toolbar">
      <div class="logo"><h1>InkRealm</h1></div>
      <div class="toolbar-actions">
        <button id="new-project" class="btn">New</button>
        <button id="save-project" class="btn">Save</button>
        <button id="export-svg" class="btn">Export</button>
        <button id="theme-toggle" class="btn">Theme</button> <!-- It's back! -->
        
        <select id="font-select" class="btn"><option value="">Google Fonts</option></select>
        <button id="convert-text" class="btn">Text to Path</button>
      </div>
    </header>

    <main class="workspace">
      <aside class="tools-panel">
        <div class="tool-group">
          <h3>Tools</h3>
          <div class="tool-buttons">
            <button class="tool-btn active" data-tool="select">Select</button>
            <button class="tool-btn" data-tool="rectangle">Rect</button>
            <button class="tool-btn" data-tool="circle">Circle</button>
            <button class="tool-btn" data-tool="path">Path</button>
            <button class="tool-btn" data-tool="text">Text</button>
          </div>
        </div>
        <div class="tool-group">
          <h3>Properties</h3>
          <label>Fill <input type="color" id="fill-color" value="#000000"></label><br><br>
          <label>Stroke <input type="color" id="stroke-color" value="#000000"></label><br><br>
          <label>Width <input type="range" id="stroke-width" min="0" max="20" value="2"></label><br><br>
          <label>Opacity <input type="range" id="opacity" min="0" max="1" step="0.1" value="1"></label>
        </div>
        <div class="tool-group">
          <h3>Layers</h3>
          <div id="layers-list"></div>
          <button id="add-layer" class="btn" style="width:100%;margin-top:10px;">+ Layer</button>
        </div>
      </aside>

      <div class="canvas-container">
        <svg id="main-canvas" width="800" height="600" viewBox="0 0 800 600">
          <g id="svg-content"></g>
        </svg>
      </div>
    </main>
  </div>

  <!-- Text Dialog -->
  <div id="text-dialog" class="dialog">
    <div class="dialog-content">
      <h3>Add Text</h3>
      <input type="text" id="text-input" placeholder="Type here..." autofocus>
      <input type="number" id="font-size" value="40" placeholder="Size">
      <div>
        <button id="apply-text" class="btn">Apply</button>
        <button id="cancel-text" class="btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Help Panel -->
  <div id="helpPanel">
    <h2>Help</h2>
    <p><strong>Draw:</strong> Click Rect, Circle, or Path.</p>
    <p><strong>Text:</strong> Click Text tool > Click Canvas > Type in box.</p>
    <p><strong>Move:</strong> Use Select tool to drag items.</p>
    <p><strong>Delete:</strong> Select item > Press Backspace.</p>
    <button id="close-help" class="btn" style="margin-top:20px;">Close</button>
  </div>
  <button id="helpToggle" class="btn" style="position:fixed;top:10px;right:10px;z-index:1001;">?</button>

  <!-- Opentype Library -->
  <script src="https://cdn.jsdelivr.net/npm/opentype.js@1.3.4/dist/opentype.min.js"></script>

  <script>
    class InkRealmSVG {
      constructor() {
        this.canvas = document.getElementById('main-canvas');
        this.content = document.getElementById('svg-content');
        this.currentTool = 'select';
        this.isDrawing = false;
        this.isDragging = false;
        this.dragElement = null;
        this.startPoint = {x:0,y:0};
        this.layers = [];
        this.activeLayer = 0;
        
        this.init();
      }

      init() {
        // Event Listeners
        this.canvas.addEventListener('mousedown', e => this.handleDown(e));
        window.addEventListener('mousemove', e => this.handleMove(e));
        window.addEventListener('mouseup', () => this.handleUp());
        
        // Buttons
        document.querySelectorAll('.tool-btn').forEach(b => {
          b.addEventListener('click', e => {
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            this.currentTool = e.target.dataset.tool;
            this.clearSelection();
          });
        });

        document.getElementById('add-layer').addEventListener('click', () => this.addLayer());
        document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());
        document.getElementById('save-project').addEventListener('click', () => this.save());
        
        // Property listeners
        ['fill-color','stroke-color','stroke-width','opacity'].forEach(id => {
          document.getElementById(id).addEventListener('input', () => this.updateSelected());
        });

        // Global Delete
        window.addEventListener('keydown', e => {
          if((e.key === 'Delete' || e.key === 'Backspace') && document.activeElement.tagName !== 'INPUT'){
            const sel = document.querySelector('.selected');
            if(sel) { sel.remove(); this.clearSelection(); }
          }
        });

        this.addLayer(); // Init first layer
      }

      toggleTheme() {
        const cur = document.documentElement.getAttribute('data-theme');
        document.documentElement.setAttribute('data-theme', cur === 'dark' ? 'light' : 'dark');
      }

      clientToSVG(x, y) {
        const pt = this.canvas.createSVGPoint();
        pt.x = x; pt.y = y;
        return pt.matrixTransform(this.canvas.getScreenCTM().inverse());
      }

      handleDown(e) {
        const pt = this.clientToSVG(e.clientX, e.clientY);
        
        // SELECT & DRAG Logic
        if (this.currentTool === 'select') {
          if (e.target !== this.canvas && e.target !== this.content) {
            this.selectElement(e.target);
            this.isDragging = true;
            this.dragElement = e.target;
            
            // Calc offset
            let tx = 0, ty = 0;
            if(this.dragElement.tagName === 'circle'){
               tx = parseFloat(this.dragElement.getAttribute('cx'));
               ty = parseFloat(this.dragElement.getAttribute('cy'));
            } else if (this.dragElement.tagName === 'rect' || this.dragElement.tagName === 'text'){
               tx = parseFloat(this.dragElement.getAttribute('x'));
               ty = parseFloat(this.dragElement.getAttribute('y'));
            } else if (this.dragElement.tagName === 'path'){
               // For paths we track start point
               this.pathStart = pt;
               const trans = this.dragElement.getAttribute('transform') || '';
               const m = trans.match(/translate\(([^, ]+)[, ]+([^)]+)\)/);
               this.dragTranslate = m ? {x:parseFloat(m[1]), y:parseFloat(m[2])} : {x:0,y:0};
            }
            this.dragOffset = { x: pt.x - tx, y: pt.y - ty };
          } else {
            this.clearSelection();
          }
          return;
        }

        // DRAW Logic
        this.isDrawing = true;
        this.startPoint = pt;
        
        if (this.currentTool === 'rectangle') {
          this.currentElement = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          this.currentElement.setAttribute('x', pt.x);
          this.currentElement.setAttribute('y', pt.y);
          this.addToActiveLayer(this.currentElement);
        } else if (this.currentTool === 'circle') {
          this.currentElement = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          this.currentElement.setAttribute('cx', pt.x);
          this.currentElement.setAttribute('cy', pt.y);
          this.addToActiveLayer(this.currentElement);
        } else if (this.currentTool === 'path') {
          this.currentElement = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          this.currentElement.setAttribute('d', `M ${pt.x} ${pt.y}`);
          this.currentElement.setAttribute('fill', 'none');
          this.addToActiveLayer(this.currentElement);
        } else if (this.currentTool === 'text') {
          this.openTextDialog(pt.x, pt.y);
          this.isDrawing = false;
        }
        
        if(this.currentElement && this.currentTool !== 'text') this.applyStyles(this.currentElement);
      }

      handleMove(e) {
        const pt = this.clientToSVG(e.clientX, e.clientY);

        // DRAG MOVE
        if (this.isDragging && this.dragElement) {
           if(this.dragElement.tagName === 'rect' || this.dragElement.tagName === 'text'){
             this.dragElement.setAttribute('x', pt.x - this.dragOffset.x);
             this.dragElement.setAttribute('y', pt.y - this.dragOffset.y);
           } else if (this.dragElement.tagName === 'circle'){
             this.dragElement.setAttribute('cx', pt.x - this.dragOffset.x);
             this.dragElement.setAttribute('cy', pt.y - this.dragOffset.y);
           } else if (this.dragElement.tagName === 'path'){
             const dx = (pt.x - this.pathStart.x) + this.dragTranslate.x;
             const dy = (pt.y - this.pathStart.y) + this.dragTranslate.y;
             this.dragElement.setAttribute('transform', `translate(${dx} ${dy})`);
           }
           return;
        }

        // DRAW MOVE
        if (!this.isDrawing || !this.currentElement) return;
        
        if (this.currentTool === 'rectangle') {
          const w = pt.x - this.startPoint.x;
          const h = pt.y - this.startPoint.y;
          this.currentElement.setAttribute('width', Math.abs(w));
          this.currentElement.setAttribute('height', Math.abs(h));
          this.currentElement.setAttribute('x', w < 0 ? pt.x : this.startPoint.x);
          this.currentElement.setAttribute('y', h < 0 ? pt.y : this.startPoint.y);
        } else if (this.currentTool === 'circle') {
          const r = Math.sqrt(Math.pow(pt.x - this.startPoint.x, 2) + Math.pow(pt.y - this.startPoint.y, 2));
          this.currentElement.setAttribute('r', r);
        } else if (this.currentTool === 'path') {
          const d = this.currentElement.getAttribute('d');
          this.currentElement.setAttribute('d', d + ` L ${pt.x} ${pt.y}`);
        }
      }

      handleUp() {
        this.isDrawing = false;
        this.isDragging = false;
        this.currentElement = null;
        this.dragElement = null;
      }

      // --- Helpers ---
      selectElement(el) {
        this.clearSelection();
        el.classList.add('selected');
        // Load properties
        if(el.getAttribute('fill')) document.getElementById('fill-color').value = el.getAttribute('fill');
      }

      clearSelection() {
        document.querySelectorAll('.selected').forEach(e => e.classList.remove('selected'));
      }

      applyStyles(el) {
        el.setAttribute('fill', document.getElementById('fill-color').value);
        el.setAttribute('stroke', document.getElementById('stroke-color').value);
        el.setAttribute('stroke-width', document.getElementById('stroke-width').value);
        el.setAttribute('opacity', document.getElementById('opacity').value);
      }

      addToActiveLayer(el) {
        const layer = document.getElementById(this.layers[this.activeLayer]);
        if(layer) layer.appendChild(el);
      }

      addLayer() {
        const id = 'layer-' + Date.now();
        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        g.id = id;
        this.content.appendChild(g);
        this.layers.push(id);
        
        const div = document.createElement('div');
        div.textContent = `Layer ${this.layers.length}`;
        div.style.padding = '5px';
        div.style.border = '1px solid #ccc';
        div.style.marginBottom = '5px';
        div.onclick = () => {
           this.activeLayer = this.layers.indexOf(id);
           document.querySelectorAll('#layers-list div').forEach(d => d.style.background = 'transparent');
           div.style.background = '#ddd';
        };
        document.getElementById('layers-list').appendChild(div);
        div.click(); // Select it
      }

      openTextDialog(x, y) {
        const dlg = document.getElementById('text-dialog');
        const inp = document.getElementById('text-input');
        const size = document.getElementById('font-size');
        const apply = document.getElementById('apply-text');
        const cancel = document.getElementById('cancel-text');

        dlg.classList.add('active');
        inp.value = ''; inp.focus();

        // One-time listener trick
        const onApply = () => {
          if (inp.value) {
            const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            t.setAttribute('x', x); t.setAttribute('y', y);
            t.textContent = inp.value;
            t.setAttribute('font-size', size.value);
            this.applyStyles(t);
            this.addToActiveLayer(t);
          }
          close();
        };
        
        const close = () => {
          dlg.classList.remove('active');
          apply.removeEventListener('click', onApply);
          cancel.removeEventListener('click', close);
        };

        apply.addEventListener('click', onApply);
        cancel.addEventListener('click', close);
      }
      
      save() {
        const svgData = new XMLSerializer().serializeToString(this.canvas);
        const blob = new Blob([svgData], {type: 'image/svg+xml'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'inkrealm-drawing.svg';
        document.body.appendChild(a); a.click(); a.remove();
      }
    }

    // Start Engine
    window.addEventListener('DOMContentLoaded', () => {
      window.app = new InkRealmSVG();
      
      // Help Toggle
      const help = document.getElementById('helpPanel');
      document.getElementById('helpToggle').onclick = () => help.classList.add('open');
      document.getElementById('close-help').onclick = () => help.classList.remove('open');
    });
  </script>
</body>
</html>
