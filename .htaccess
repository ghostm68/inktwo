<?php
/*  inkrealm.info  –  ultra-simple logger + optional e-mail alerts
    1. receives JSON hits from plausible-compatible JS
    2. appends to hits.log
    3. mails you if engagement < 50 % or JS error detected
*/

$raw = file_get_contents('php://input');   // grab POST body
if (!$raw) { http_response_code(400); exit('No data'); }

$json = json_decode($raw, true);
if (!is_array($json)) { http_response_code(400); exit('Bad JSON'); }

// 1) ----- write to log file (one line per hit) -----
$line = gmdate('Y-m-d H:i:s') . '  ' . json_encode($json, JSON_UNESCAPED_SLASHES) . PHP_EOL;
file_put_contents(__DIR__ . '/hits.log', $line, FILE_APPEND | LOCK_EX);

// 2) ----- optional: e-mail alerts -----
$to      = 'inkrealm2026@gmail.com';   // <— change to your address
$subject = null;

// slow / bounce alert  (engagement event & scroll-depth < 50 %)
if (($json['n'] ?? '') === 'engagement' && (int)($json['sd'] ?? 0) < 50) {
    $subject = 'Slow page: ' . ($json['u'] ?? 'unknown');
}

// JS error alert
if (($json['n'] ?? '') === 'error') {
    $subject = 'JS error on ' . ($json['u'] ?? 'unknown');
}

if ($subject) {
    // simple text mail
    mail($to, $subject, $line, 'From: logger@inkrealm.info');
}

// 3) ----- tell browser “saved” -----
http_response_code(204);   // 204 No Content
