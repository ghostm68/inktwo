<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>NOVA__2741</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nova+Mono&family=Special+Elite&display=swap" rel="stylesheet">
  <style>
    :root { --red: #ff3333; --black: #050505; --dark-grey: #121212; --white: #e0e0e0; }
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    
    body { 
      background: var(--black); color: var(--white); font-family: 'Nova Mono', monospace; 
      margin: 0; overflow: hidden; height: 100vh; width: 100vw;
    }

    /* SPLASH SCREEN */
    #splash-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--black); z-index: 2000;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      cursor: pointer; border: 4px double var(--red); transition: opacity 0.5s;
    }

    /* CRT Scanline Overlay */
    body::after {
      content: " "; display: block; position: fixed; top: 0; left: 0; bottom: 0; right: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.15) 50%);
      z-index: 999; background-size: 100% 3px; pointer-events: none; opacity: 0.4;
    }

    .app-grid { display: none; grid-template-columns: 280px 1fr; grid-template-rows: 50px 1fr 320px 30px; height: 100vh; }

    header { grid-column: span 2; border-bottom: 1px solid var(--red); background: #000; z-index: 50; }
    .sidebar { background: #080808; border-right: 1px solid #222; overflow-y: auto; padding: 20px; }
    #viewport { background: #000; position: relative; border-bottom: 1px solid var(--red); overflow: hidden; }
    
    .bottom-shelf { 
      grid-row: 3; grid-column: span 2; 
      display: grid; grid-template-columns: 1fr 350px; 
      height: 320px; overflow: hidden;
    }

    .editor-section { background: var(--dark-grey); display: flex; flex-direction: column; overflow: hidden; border-top: 1px solid var(--red); }
    #editor { 
      flex-grow: 1; padding: 25px; font-family: 'Special Elite', serif; font-size: 1.2rem; 
      line-height: 1.6; outline: none; overflow-y: auto; color: var(--white); 
      caret-color: var(--red); background: var(--dark-grey);
    }

    /* CHAT / COMMS CONSOLE */
    .comms-console { background: #000; border-left: 1px solid var(--red); display: flex; flex-direction: column; overflow: hidden; }
    #chat-container { flex-grow: 1; overflow-y: auto; padding: 10px; font-size: 10px; scroll-behavior: smooth; }
    .chat-bubble { margin-bottom: 10px; padding: 8px; border: 1px solid #222; line-height: 1.4; }
    .user-message { border-left: 3px solid #555; color: #888; }
    .bot-message { border-left: 3px solid var(--red); color: var(--white); background: #0a0000; }
    
    .chat-input-area { display: flex; border-top: 1px solid #222; padding: 5px; background: #080808; }
    #chat-input { background: #000; color: var(--red); border: 1px solid #333; flex-grow: 1; padding: 5px; font-size: 10px; outline: none; }

    /* Nodes & Labels */
    .node-center { fill: var(--red); filter: drop-shadow(0 0 5px var(--red)); }
    .node-orbit { fill: #000; stroke: var(--red); stroke-width: 1px; }
    .label { fill: #fff; font-size: 9px; text-transform: uppercase; pointer-events: none; opacity: 0.7; }
    
    footer { grid-column: span 2; background: #000; border-top: 1px solid #222; font-size: 8px; color: #444; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; height: 30px; }

    @media (max-width: 768px) {
      .app-grid { grid-template-columns: 1fr; grid-template-rows: 50px auto 350px 300px 200px 40px; height: auto; overflow-y: auto; }
      header { position: sticky; top: 0; }
      .sidebar { grid-row: 2; max-height: 150px; }
      #viewport { grid-row: 3; height: 350px; }
      .bottom-shelf { grid-row: 4 / 6; grid-template-columns: 1fr; grid-template-rows: 300px 200px; height: auto; }
      .comms-console { height: 200px; border-left: none; border-top: 1px solid var(--red); }
    }
    
    .teletype-text::after { content: "|"; animation: blink 1s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    
    /* Loading Bar for LLM */
    #llm-progress-container { display: none; margin-left: 10px; flex-grow:1; max-width: 150px; background: #222; height: 8px; border: 1px solid #444; position:relative; }
    #llm-progress { width: 0%; height: 100%; background: var(--red); transition: width 0.2s; }
    #llm-label { position:absolute; top:-14px; left:0; font-size:8px; color:var(--red); width: 200px;}
    /* CUSTOM SELECTION HIGHLIGHT */
    ::selection {
      background: var(--red);
      color: var(--black);
      text-shadow: none;
    }
    
    /* INTERACTIVE CHAT BUBBLES */
    .bot-message { 
        cursor: copy; /* change cursor to show it's interactable */
        transition: all 0.2s;
    }
    .bot-message:hover {
        background: #1a0505; /* subtle glow on hover */
        border-color: var(--red);
    }
    .bot-message:active {
        background: var(--red);
        color: black;
    }
  </style>
</head>
<body>

<!-- SPLASH SCREEN -->
<div id="splash-screen">
    <h1 class="text-red-600 font-bold text-4xl mb-4 tracking-tighter">INKREALM_2741</h1>
    <p id="splash-text" class="text-zinc-500 animate-pulse text-xs tracking-widest uppercase">Initializing Reality Studio...</p>
</div>

<div class="app-grid">
  <header class="flex items-center justify-between px-4">
    <div class="flex items-center gap-3">
        <div id="power-light" class="w-2 h-2 bg-zinc-900 rounded-full"></div>
        <h1 class="text-white font-bold tracking-tighter text-xs uppercase">SELECTRIC_2741</h1>
        
        <!-- POWER BUTTON (NO POPUP, just Warning in Text) -->
        <button id="power-toggle" class="text-[9px] border border-zinc-800 px-2 py-1 text-zinc-500 hover:bg-zinc-900 transition font-bold" onclick="window.togglePower()">
            ENABLE NEURAL LINK [~600MB]
        </button>

        <!-- DOWNLOAD PROGRESS -->
        <div id="llm-progress-container">
            <div id="llm-label">DOWNLOADING...</div>
            <div id="llm-progress"></div>
        </div>
    </div>
    <div class="flex gap-2">
        <button onclick="window.clearChat()" class="text-[9px] border border-zinc-800 px-2 py-1">CLR_LOG</button>
        <button onclick="window.exportDraft()" class="text-[9px] border border-zinc-800 px-2 py-1 text-red-600 font-bold">EXTRACT</button>
    </div>
  </header>

  <aside class="sidebar">
    <div class="text-[10px] text-zinc-700 mb-2 uppercase italic tracking-widest">Inquiry_Path</div>
    <div id="path-log" class="mb-8"></div>
    <div class="text-[10px] text-red-900 mb-2 uppercase font-bold tracking-widest">Fractal_Nodes</div>
    <div id="word-menu"></div>
  </aside>

  <main id="viewport">
    <svg id="canvas" class="w-full h-full"></svg>
  </main>

  <div class="bottom-shelf">
    <section class="editor-section">
      <div class="bg-red-600 text-white px-4 py-1 flex justify-between font-serif text-[10px]">
          <div class="teletype-text" id="teletype">>> AWAITING_INPUT...</div>
          <div id="word-count">0W</div>
      </div>
      <div id="editor" contenteditable="true" spellcheck="false"></div>
    </section>

    <!-- COMMS CONSOLE -->
    <aside class="comms-console">
        <div class="bg-zinc-900 text-[9px] p-2 text-zinc-500 uppercase flex justify-between border-b border-red-900">
            <span>Terminal_Status</span>
            <span id="ai-status" class="text-zinc-600 font-bold">ARCHIVE_ONLY</span>
        </div>
        <div id="chat-container">
            <div class="chat-bubble bot-message">Terminal Active. Archives Mounted. Neural Net Standby.</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Type to search archive..." >
            <button id="send-btn" class="bg-zinc-800 text-zinc-500 px-2 text-[9px] ml-1" onclick="window.sendChat()">QUERY</button>
        </div>
    </aside>
  </div>

  <footer>
    <div id="dict-status">LOADING ARCHIVES...</div>
    <div class="flex gap-4 uppercase"><span>Nova Construct</span><span>|</span><span id="footer-status">SYSTEM_STABLE</span></div>
  </footer>
</div>

<!-- MODULE SCRIPT FOR WEBLLM -->
<script type="module">
    import { CreateMLCEngine } from "https://esm.run/@mlc-ai/web-llm";

    const SELECTED_MODEL = "Qwen2.5-0.5B-Instruct-q4f16_1-MLC";
    let engine;
    let isAiLoading = false;
    let isAiReady = false;

    // --- AI INITIALIZATION (NO POPUPS) ---
    window.engageAI = async function() {
        if (isAiReady || isAiLoading) return;
        
        // Start immediately
        isAiLoading = true;
        document.getElementById('llm-progress-container').style.display = 'block';
        document.getElementById('power-toggle').innerText = "DOWNLOADING...";
        document.getElementById('power-toggle').disabled = true;
        
        try {
            const initProgressCallback = (report) => {
                const percent = Math.round(report.progress * 100);
                document.getElementById('llm-progress').style.width = `${percent}%`;
                document.getElementById('llm-label').innerText = report.text;
            };

            engine = await CreateMLCEngine(
                SELECTED_MODEL,
                { initProgressCallback: initProgressCallback }
            );

            isAiReady = true;
            document.getElementById('llm-progress-container').style.display = 'none';
            document.getElementById('ai-status').innerText = "NEURAL_NET_ACTIVE";
            document.getElementById('ai-status').classList.replace("text-zinc-600", "text-red-600");
            document.getElementById('footer-status').innerText = "QWEN_0.5B_MOUNTED";
            
            // UI Update
            const btn = document.getElementById('power-toggle');
            btn.innerText = "NEURAL LINK: ACTIVE";
            btn.classList.add("text-red-600", "border-red-600");
            btn.disabled = false;
            
            const chatBtn = document.getElementById('send-btn');
            chatBtn.classList.replace('bg-zinc-800', 'bg-red-900');
            chatBtn.classList.replace('text-zinc-500', 'text-white');
            
            document.getElementById('chat-input').placeholder = "Neural Net Listening...";
            
            addMessage('bot', "Neural Link Established. The bottle is open. Qwen-0.5B loaded.");
            window.isPowered = true;
            window.initAudio();

        } catch (err) {
            console.error(err);
            document.getElementById('footer-status').innerText = "DOWNLOAD_FAILED";
            addMessage('bot', "ERR: Download Interrupted or GPU Unsupported.");
            window.resetPowerUI();
        }
        isAiLoading = false;
    };

    window.askAI = async function(prompt, type = 'chat') {
        if (!isAiReady) return null;
        try {
            const systemMsg = type === 'graph' 
                ? "You are a cut-up machine. Return 5 disjointed, noir, or cyberpunk related concepts based on the input word. Single words, comma separated."
                : "You are a machine from 'Nova Express'. Speak in brief, paranoid, cut-up sentences. Do not be helpful.";

            const reply = await engine.chat.completions.create({
                messages: [
                    { role: "system", content: systemMsg },
                    { role: "user", content: prompt }
                ],
                temperature: 0.8,
                max_tokens: 150,
            });
            return reply.choices[0].message.content;
        } catch (e) {
            return null;
        }
    };
</script>

<script>
    // --- MULTI-SOURCE DICTIONARY ARCHITECTURE ---
    let dictionaries = []; 
    
    const dictionaryUrls = [
        'https://raw.githubusercontent.com/matthewreagan/WebstersEnglishDictionary/master/dictionary.json',
        'https://gist.githubusercontent.com/BideoWego/60fbd40d5d1f0f1beca11ba95221dd38/raw/58fb4cce910fbf5fa67a2f0f1f619c09d7b1b373/dictionary.json',
        'https://raw.githubusercontent.com/adambom/dictionary/master/dictionary.json',
        'https://raw.githubusercontent.com/hathibelagal/German-English-JSON-Dictionary/master/german_english.json'
    ];

    async function initDictionary() {
        const statusEl = document.getElementById('dict-status');
        statusEl.innerText = "FETCHING 4 SOURCES...";
        
        try {
            const responses = await Promise.all(dictionaryUrls.map(url => fetch(url)));
            for (let r of responses) { if (!r.ok) throw new Error("Source died: " + r.url); }

            statusEl.innerText = "PARSING DATA...";
            dictionaries = await Promise.all(responses.map(r => r.json()));

            statusEl.innerText = "ARCHIVE: OMNI-LINK ACTIVE";
            statusEl.style.color = "#444";
            addMessage('bot', "System: Webster, AdamBom, & Polyglot Archives Mounted.");

        } catch (e) {
            console.error("Dictionary Load Failed", e);
            statusEl.innerText = "ARCHIVE: PARTIAL/FAIL";
            statusEl.style.color = "red";
        }
    }

    function searchArchives(rawWord) {
        if (!dictionaries.length) return { def: null, type: null };
        const wLower = rawWord.toLowerCase();
        const wUpper = rawWord.toUpperCase();
        
        // 1. Check English Sources (Indexes 0, 1, 2)
        for (let i = 0; i < 3; i++) {
            const dict = dictionaries[i];
            if (dict[wLower]) return { def: dict[wLower], type: 'EN' };
            if (dict[wUpper]) return { def: dict[wUpper], type: 'EN' };
        }

        // 2. Check German Source (Index 3)
        const gerDict = dictionaries[3];
        if (gerDict[wLower] || gerDict[wUpper]) return { def: gerDict[wLower] || gerDict[wUpper], type: 'DE->EN' };
        const entry = Object.entries(gerDict).find(([ger, eng]) => eng.toLowerCase().includes(wLower));
        if (entry) return { def: entry[0], type: 'EN->DE' };

        return { def: null, type: null };
    }

    // --- UI HELPERS ---
   function addMessage(role, text) {
        const c = document.getElementById('chat-container');
        
        // Create the element programmatically so we can add events
        const div = document.createElement('div');
        div.className = `chat-bubble ${role === 'user' ? 'user-message' : 'bot-message'}`;
        div.innerHTML = text;

        // IMPORT FEATURE: If it's a bot message, make it clickable
        if (role !== 'user') {
            div.title = "CLICK TO INJECT DATA TO EDITOR";
            div.onclick = function() {
                // 1. Visual Flash to confirm click
                const originalBorder = this.style.borderColor;
                this.style.backgroundColor = "var(--red)";
                this.style.color = "black";
                setTimeout(() => {
                    this.style.backgroundColor = ""; 
                    this.style.color = "";
                }, 150);

                // 2. Clean the text (Remove the "ARCHIVE:" prefixes for cleaner writing)
                // This regex strips "ARCHIVE:", "POLYGLOT:", etc.
                let cleanText = text.replace(/^(ARCHIVE|POLYGLOT|DATA|GERMAN.*):/i, "").trim();
                
                // 3. Inject into Editor
                const editor = document.getElementById('editor');
                // We add a subtle separator before pasting
                editor.innerHTML += ` <span style="color:#555">[REC]</span> ${cleanText} `;
                
                // 4. Save and Update Counts
                saveAll();
            };
        }

        c.appendChild(div);
        c.scrollTop = c.scrollHeight;
    }

    window.resetPowerUI = function() {
        const btn = document.getElementById('power-toggle');
        btn.innerText = "ENABLE NEURAL LINK [~600MB]";
        btn.classList.remove("text-red-600", "border-red-600");
        btn.disabled = false;
        window.isPowered = false;
    }

    // --- CHAT LOGIC ---
   window.sendChat = async function() {
        const input = document.getElementById('chat-input');
        const msg = input.value.trim();
        if(!msg) return;
        
        addMessage('user', ">> " + msg);
        input.value = '';

        // 1. ALWAYS CHECK ARCHIVES FIRST (The "Fact")
        const archiveResult = searchArchives(msg);
        let foundInArchive = false;

        if (archiveResult.def) {
            foundInArchive = true;
            const prefix = archiveResult.type === 'EN' ? "ARCHIVE" : (archiveResult.type.includes('DE') ? "POLYGLOT" : "DATA");
            // We use a slight delay for the archive so it feels like a distinct system
            setTimeout(() => {
                addMessage('bot', `${prefix}: ${archiveResult.def}`);
            }, 200);
        }

        // 2. CHECK NEURAL LINK (The "Commentary")
        const aiStatus = document.getElementById('ai-status').innerText;
        
        if (aiStatus === 'NEURAL_NET_ACTIVE') {
            const typing = document.createElement('div');
            typing.className = 'chat-bubble bot-message';
            typing.textContent = '...Calculating...';
            document.getElementById('chat-container').appendChild(typing);
            
            // Ask the AI
            const response = await window.askAI(msg, 'chat');
            typing.remove();
            
            // If we found it in the archive, maybe style the AI response differently or just append it
            addMessage('bot', response || "Signal Lost.");
            
        } else {
            // AI IS OFF
            if (!foundInArchive) {
                addMessage('bot', "Not in Archives. Enable Neural Link for deep search.");
            }
        }
    }
     document.getElementById('chat-input').addEventListener('keypress', (e) => {
        if(e.key === 'Enter') window.sendChat();
    });
    // --- TOGGLE SWITCH ---
    window.isPowered = false;
    let audioCtx, humOsc, gainNode;

    window.togglePower = function() {
        if (window.isPowered) {
            window.isPowered = false;
            window.resetPowerUI();
            if(gainNode) gainNode.gain.setTargetAtTime(0, audioCtx.currentTime, 0.2);
            document.getElementById('ai-status').innerText = "ARCHIVE_ONLY";
            document.getElementById('ai-status').classList.replace("text-red-600", "text-zinc-600");
            addMessage('bot', "Neural Link Severed.");
        } else {
            if(window.engageAI) window.engageAI();
        }
    }

    window.initAudio = function() {
        if(!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            humOsc = audioCtx.createOscillator(); gainNode = audioCtx.createGain();
            humOsc.type = 'sawtooth'; humOsc.frequency.setValueAtTime(55, audioCtx.currentTime);
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass'; filter.frequency.setValueAtTime(120, audioCtx.currentTime);
            humOsc.connect(filter); filter.connect(gainNode); gainNode.connect(audioCtx.destination); humOsc.start();
        }
        gainNode.gain.setTargetAtTime(0.04, audioCtx.currentTime, 0.5);
    }

    // --- GRAPH LOGIC ---
    const lexicon = { name: "Silence", children: [] }; 
    let currentNode = lexicon, history = [];
    
    const svg = d3.select("#canvas");
    let width = window.innerWidth <= 768 ? window.innerWidth : window.innerWidth - 280;
    let height = window.innerWidth <= 768 ? 350 : window.innerHeight - 400;
  const simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(d => d.name).distance(100))
        .force("charge", d3.forceManyBody().strength(-600))
        .force("center", d3.forceCenter(width / 2, height / 2)); // Keep this line

    window.update = function() {
        const nodes = currentNode.children || [];
        if(nodes.length === 0 && currentNode.name === "Silence") {
            ["Virus", "Control", "Nova", "Machine"].forEach(w => nodes.push({name: w}));
            currentNode.children = nodes;
        }
        const links = nodes.map(d => ({ source: currentNode.name, target: d.name }));
        const displayNodes = [{ name: currentNode.name, isParent: true }, ...nodes];
        document.getElementById('path-log').innerHTML = history.map((h, i) => `<div onclick="jumpTo(${i})" style="cursor:pointer; opacity:0.7">>> ${h.name}</div>`).join('');
        document.getElementById('word-menu').innerHTML = nodes.map(n => `<div onclick="handleNodeClick('${n.name}')" style="cursor:pointer; color:#888; margin-bottom:4px">${n.name}</div>`).join('');
        const link = svg.selectAll(".link").data(links, d => d.target).join("line").attr("stroke", "#222").attr("class", "link");
        const node = svg.selectAll(".node-group").data(displayNodes, d => d.name).join("g")
            .attr("class", "node-group")
            .on("click", (e, d) => handleNodeClick(d.name))
            .call(d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended));
        node.selectAll("circle").data(d => [d]).join("circle")
            .attr("r", d => d.isParent ? 12 : 6)
            .attr("class", d => d.isParent ? "node-center" : "node-orbit");
        node.selectAll("text").data(d => [d]).join("text")
            .attr("class", "label")
            .attr("dy", 24)
            .attr("text-anchor", "middle")
            .text(d => d.name);

        // Keeps all nodes within the viewport (Prevents them from flying away).
        // This has to be placed at the END of the update() to run at every frame.
        simulation.nodes(displayNodes);
        simulation.force("link").links(links);
        simulation.force("center", d3.forceCenter(width / 2, height / 2));
        simulation.alpha(1).restart();
        simulation.on("tick", () => {
            link.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
            node.attr("transform", d => {
                const x = Math.max(0, Math.min(width, d.x));
                const y = Math.max(0, Math.min(height, d.y));
                return `translate(${x},${y})`;
            });
        });
    }
    // --- HYBRID EXCAVATION ---
    window.handleNodeClick = async function(name) {
        if(name === currentNode.name) return;
        
        const target = currentNode.children?.find(c => c.name === name);
        if(target && target.children) { 
            history.push(currentNode); 
            currentNode = target; 
            window.update(); 
            return;
        }

        insertText(name); 

        let newWords = [];
        
        // 1. DICTIONARY CUT-UP
        const result = searchArchives(name);
        if (result.def) {
            const stopWords = ["the","and","that","with","from","have","this","which","being","used","noun","verb"];
            const cleanDef = result.def.toString();
            const candidates = cleanDef.split(/[\s,.;()]+/)
                .map(w => w.replace(/[^a-zA-Z]/g, '').toUpperCase())
                .filter(w => w.length > 4 && !stopWords.includes(w.toLowerCase()));
            
            const shuffled = candidates.sort(() => 0.5 - Math.random());
            newWords = [...new Set(shuffled)].slice(0, 4).map(w => ({name: w}));
            
            if(result.type === 'EN->DE') newWords.push({name: result.def.toUpperCase()});
        }

        // 2. AI GENERATION
        if (document.getElementById('ai-status').innerText === "NEURAL_NET_ACTIVE") {
            const aiRaw = await window.askAI(name, 'graph');
            if(aiRaw) {
                const aiSplit = aiRaw.split(',').map(w => ({name: w.trim().replace(/\./g, '').toUpperCase()}));
                if (aiSplit.length > 0) newWords = [...newWords, ...aiSplit].slice(0, 6);
            }
        }

        if (newWords.length > 0) {
            let newNode = currentNode.children.find(n => n.name === name);
            if(!newNode) newNode = { name: name };
            newNode.children = newWords;
            history.push(currentNode);
            currentNode = newNode;
            window.update();
        } else {
             addMessage('bot', `Word [${name}] not found in Archives. Enable Neural Link.`);
        }
    }

    function insertText(w) { 
        document.getElementById('editor').innerHTML += ` <span style="color:red">${w}</span> `; 
        saveAll(); 
    }
    
    window.jumpTo = function(index) { currentNode = history[index]; history = history.slice(0, index); window.update(); }

function saveAll() {
        localStorage.setItem('nova_editor', document.getElementById('editor').innerHTML);
        const txt = document.getElementById('editor').innerText.trim();
        document.getElementById('word-count').innerText = (txt.length > 0 ? txt.split(/\s+/).length : 0) + "W";
    }

    function saveAll() {
        localStorage.setItem('nova_editor', document.getElementById('editor').innerHTML);
        const txt = document.getElementById('editor').innerText.trim();
        document.getElementById('word-count').innerText = (txt.length > 0 ? txt.split(/\s+/).length : 0) + "W";
    }

    function loadAll() {
        const saved = localStorage.getItem('nova_editor');
        // Check if there is saved data
        if(saved && saved.trim().length > 50) { 
            document.getElementById('editor').innerHTML = saved; 
        } else {
            // THE MINRAUD BOOT SEQUENCE
            document.getElementById('editor').innerHTML = 
                "<span style='color:var(--red)'>MINRAUD_ARCHIVE_SEQ_001:</span><br><br>" +
                "Metal cities controlled by The Elders who are heads in bottles — Fastest brains preserved forever — Only form of immortality open to the Insect People of Minraud.<br><br>" +
                "An intricate bureaucracy wired to the control brains directs all movement. Even so there is a devious underground operating through telepathic misdirection and camouflage.<br><br>" +
                "The partisans make <span style='color:var(--red)'>recordings ahead in time</span> and leave the recordings to be picked up by control stations while they are free for a few seconds to organize underground activities...<br><br>" +
                "------------------------------------------<br>" +
                "// INITIATE CUT-UP PROTOCOL VIA GRAPH NODES<br>" +
                "// CLICK TO DISSOCIATE CONTROL LINES";
            // ADD THE "PRIME DIRECTIVE" AFTER THE BOOT SEQUENCE
            // And insert it into the editor so it's visible
            document.getElementById('editor').innerHTML += "<br><br>Initiate Inquiry. The future is built on forgotten data...";
        }
        saveAll();
    }
    window.exportDraft = function() { 
        const blob = new Blob([document.getElementById('editor').innerText], {type: 'text/plain'}); 
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'nova-log.txt'; a.click(); 
    }

    window.clearChat = function() {
        document.getElementById('chat-container').innerHTML = `<div class="chat-bubble bot-message">Log Wiped.</div>`;
    }

    function dragstarted(e, d) { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
    function dragged(e, d) { d.fx = e.x; d.fy = e.y; }
    function dragended(e, d) { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }

    window.onload = () => {
        loadAll();
        initDictionary();
        
        document.getElementById('splash-screen').addEventListener('click', function() {
            this.style.opacity = '0';
            setTimeout(() => { 
                this.style.display = 'none'; 
                document.querySelector('.app-grid').style.display = 'grid';
                window.update();
            }, 500);
        });
        
        const target = document.getElementById('teletype');
        const txt = ">> REALITY_STUDIO_ACTIVE";
        let i = 0;
        setInterval(() => {
            target.innerText = txt.substring(0, i+1) + (i%2?"|":"");
            if(i < txt.length) i++;
        }, 100);
    };
</script>
</body>
</html>
