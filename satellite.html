<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>INK REALM // COMMAND CENTER</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Special+Elite&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0a0a0a;
      --panel-bg: #111;
      --border: #333;
      --text: #e0e0e0;
      --accent: #8a1c1c;
      --accent-dim: rgba(138, 28, 28, 0.3);
      --paper: #e6e6e6;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background-color: var(--bg-dark);
      font-family: 'IBM Plex Mono', monospace;
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* --- BACKGROUND --- */
    .bg-video {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      object-fit: cover; opacity: 0.15; z-index: -2;
      filter: grayscale(100%) contrast(1.2);
    }
    .vignette {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: radial-gradient(circle at center, transparent 40%, #000 100%);
      z-index: -1; pointer-events: none;
    }

    /* --- MAIN LAYOUT (3-Column Grid) --- */
    .dashboard {
      display: grid;
      grid-template-columns: 260px 1fr 260px; /* Sidebars fixed, Center flexes */
      gap: 15px;
      width: 98%;
      max-width: 1600px;
      height: 92vh;
      position: relative;
      z-index: 10;
    }

    /* --- COMMON PANEL STYLES --- */
    .panel {
      background: rgba(15, 15, 15, 0.9);
      border: 1px solid var(--border);
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .panel-header {
      background: #050505;
      padding: 10px;
      border-bottom: 1px solid var(--border);
      font-size: 10px;
      letter-spacing: 2px;
      color: #666;
      font-weight: 600;
      text-transform: uppercase;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #333; }
    .status-dot.active { background: #0f0; box-shadow: 0 0 5px #0f0; }

    /* --- LEFT: NEURAL TERMINAL --- */
    .terminal-panel { border-top: 2px solid var(--accent); }
    
    .chat-log {
      flex: 1;
      background: #080808;
      padding: 12px;
      overflow-y: auto;
      font-size: 11px;
      color: #888;
      font-family: 'IBM Plex Mono', monospace;
    }
    
    .log-msg { margin-bottom: 8px; line-height: 1.4; word-wrap: break-word; }
    .log-msg.user { color: #fff; border-left: 2px solid #333; padding-left: 8px; }
    .log-msg.sys { color: var(--accent); }
    
    .chat-controls { padding: 10px; background: #111; border-top: 1px solid #222; }
    
    .chat-input {
      width: 100%; background: #000; border: 1px solid #333;
      color: #fff; padding: 8px; font-family: inherit; margin-bottom: 8px;
      font-size: 11px; outline: none;
    }
    .chat-input:focus { border-color: #666; }
    
    .btn-full { 
      width: 100%; padding: 6px; background: #222; border: 1px solid #333; 
      color: #888; cursor: pointer; font-size: 10px; text-transform: uppercase; 
    }
    .btn-full:hover { background: #333; color: #fff; }

    /* --- CENTER: TYPEWRITER EDITOR --- */
    .editor-panel {
      border: 1px solid #333;
      background: linear-gradient(180deg, #1a1a1a, #0d0d0d);
    }

    .toolbar {
      padding: 8px 12px;
      background: #111;
      border-bottom: 1px solid #222;
      display: flex; gap: 6px; align-items: center;
      flex-wrap: wrap;
    }

    .btn {
      background: #1a1a1a; border: 1px solid #333; color: #888;
      padding: 5px 10px; font-family: inherit; font-size: 11px;
      cursor: pointer; min-width: 30px;
    }
    .btn:hover { background: #333; color: #fff; }
    .btn.accent:hover { color: var(--accent); border-color: var(--accent); }
    
    .sep { width: 1px; height: 16px; background: #333; margin: 0 4px; }

    .paper-container {
      flex: 1;
      background: #050505;
      padding: 20px;
      overflow: hidden;
      display: flex;
      justify-content: center;
    }

    .paper-sheet {
      background: var(--paper);
      width: 100%;
      max-width: 800px; /* Limits width so lines aren't too long */
      height: 100%;
      padding: 40px 50px;
      font-family: 'Special Elite', 'Courier New', serif;
      font-size: 18px;
      line-height: 1.6;
      color: #111;
      outline: none;
      overflow-y: auto;
      white-space: pre-wrap;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    /* Selection & Formatting */
    .paper-sheet::selection, .paper-sheet *::selection { background: var(--accent-dim); }
    .paper-sheet b { font-weight: 900; }
    .paper-sheet i { font-style: italic; }
    .paper-sheet u { text-decoration-color: var(--accent); text-decoration-thickness: 2px; }
    
    .stamp-block { 
      display: inline-block; border: 2px solid var(--accent); color: var(--accent);
      padding: 2px 6px; font-weight: bold; transform: rotate(-2deg); font-size: 14px;
    }
    .redacted { background: #000; color: #000; padding: 0 4px; cursor: help; }
    .redacted:hover { color: #fff; }

    /* --- RIGHT: NOTEPAD --- */
    .notepad-panel { border-top: 2px solid #fff; }
    
    #note-input {
      flex: 1; width: 100%;
      background: #111; color: #bbb;
      border: none; outline: none; resize: none;
      padding: 15px; font-family: 'Special Elite', monospace; font-size: 13px;
      line-height: 1.5;
    }
    
    .note-footer {
      padding: 8px; background: #080808; border-top: 1px solid #222;
      font-size: 10px; color: #555; display: flex; justify-content: space-between;
    }

    /* Scrollbars */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #050505; }
    ::-webkit-scrollbar-thumb { background: #333; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }

    /* Responsive: Stack on mobile */
    @media (max-width: 1000px) {
      .dashboard { grid-template-columns: 1fr; height: auto; overflow-y: auto; display: block; }
      .panel { height: 400px; margin-bottom: 20px; }
      body { height: auto; padding: 20px 0; align-items: flex-start; }
    }
  </style>
</head>
<body>

  <video class="bg-video" autoplay muted loop playsinline>
    <source src="https://assets.mixkit.co/videos/preview/mixkit-typing-on-a-vintage-typewriter-close-up-4094-large.mp4" type="video/mp4">
  </video>
  <div class="vignette"></div>

  <div class="dashboard">
    
    <!-- LEFT: NEURAL TERMINAL (WebLLM) -->
    <div class="panel terminal-panel">
      <div class="panel-header">
        <span>NEURAL LINK</span>
        <div class="status-dot" id="ai-status-dot"></div>
      </div>
      <div class="chat-log" id="chat-log">
        <div class="log-msg sys">// System initialized.</div>
        <div class="log-msg sys">// Core Status: OFFLINE</div>
      </div>
      <div class="chat-controls">
        <input type="text" class="chat-input" id="chat-input" placeholder="Enter command...">
        <button class="btn-full" id="chat-send">TRANSMIT</button>
      </div>
    </div>

    <!-- CENTER: TYPEWRITER (Main) -->
    <div class="panel editor-panel">
      <div class="panel-header">
        <span>INK REALM // TYPE II</span>
        <span id="save-status" style="color:#444">READY</span>
      </div>
      
      <div class="toolbar">
        <button class="btn" data-cmd="bold"><b>B</b></button>
        <button class="btn" data-cmd="italic"><i>I</i></button>
        <button class="btn" data-cmd="underline"><u>U</u></button>
        <div class="sep"></div>
        <button class="btn" id="btn-redact">██</button>
        <button class="btn accent" id="btn-stamp">STAMP</button>
        <button class="btn" id="btn-date">DATE</button>
        <div class="sep"></div>
        <button class="btn" id="btn-save">SAVE</button>
        <button class="btn" id="btn-clear">CLEAR</button>
      </div>

      <div class="paper-container">
        <div id="paper" class="paper-sheet" contenteditable="true" spellcheck="false"></div>
      </div>
    </div>

    <!-- RIGHT: NOTEPAD (URL Hash Save) -->
    <div class="panel notepad-panel">
      <div class="panel-header">
        <span>SCRATCHPAD</span>
        <span>SYNCED</span>
      </div>
      <textarea id="note-input" placeholder="// Notes auto-save to URL..."></textarea>
      <div class="note-footer">
        <span id="note-count">0 chars</span>
        <span id="note-status">IDLE</span>
      </div>
    </div>

  </div>

<script>
/**
 * INK REALM COMMAND CENTER
 * Integrated: ContentEditable Editor + WebLLM AI + URL Hash Notepad
 */
document.addEventListener('DOMContentLoaded', () => {

    // --- 1. TYPEWRITER ENGINE (Center) ---
    const paper = document.getElementById('paper');
    const saveStatus = document.getElementById('save-status');

    // Init Content
    if(!localStorage.getItem('ink-main')) {
        paper.innerHTML = `<div><b>CONFIDENTIAL REPORT</b></div><div><br></div><div>Subject: _________________</div><div>Date: <span class="redacted">1985-10-25</span></div><div><br></div><div>The quick brown fox jumps over the lazy dog.</div>`;
    } else {
        paper.innerHTML = localStorage.getItem('ink-main');
    }

    // Formatting Logic
    document.querySelectorAll('.btn[data-cmd]').forEach(btn => {
        btn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            document.execCommand(btn.dataset.cmd, false, null);
        });
    });

    // Special Tools
    document.getElementById('btn-date').addEventListener('mousedown', (e) => {
        e.preventDefault();
        const d = new Date().toISOString().split('T')[0];
        document.execCommand('insertText', false, ` [${d}] `);
    });

    document.getElementById('btn-redact').addEventListener('mousedown', (e) => {
        e.preventDefault();
        const sel = window.getSelection();
        const html = sel.toString().length > 0 
            ? `<span class="redacted">${sel.toString()}</span>`
            : `<span class="redacted">██████</span>`;
        document.execCommand('insertHTML', false, html);
    });

    document.getElementById('btn-stamp').addEventListener('mousedown', (e) => {
        e.preventDefault();
        document.execCommand('insertHTML', false, `&nbsp;<span class="stamp-block">TOP SECRET</span>&nbsp;`);
    });

    document.getElementById('btn-save').addEventListener('click', () => {
        localStorage.setItem('ink-main', paper.innerHTML);
        flashStatus('SAVED TO DISK');
    });

    document.getElementById('btn-clear').addEventListener('click', () => {
        if(confirm("Shred document?")) paper.innerHTML = '';
    });

    function flashStatus(msg) {
        saveStatus.textContent = msg;
        saveStatus.style.color = '#fff';
        setTimeout(() => {
            saveStatus.textContent = 'READY';
            saveStatus.style.color = '#444';
        }, 2000);
    }


    // --- 2. NOTEPAD ENGINE (Right - URL Hash) ---
    const noteInput = document.getElementById('note-input');
    const noteStatus = document.getElementById('note-status');
    const noteCount = document.getElementById('note-count');

    // Compression Utilities
    async function compress(str) {
        if(!str) return '';
        const stream = new Blob([str]).stream().pipeThrough(new CompressionStream('gzip'));
        const buffer = await new Response(stream).arrayBuffer();
        return btoa(String.fromCharCode(...new Uint8Array(buffer)));
    }

    async function decompress(str) {
        if(!str) return '';
        try {
            const stream = new Blob([Uint8Array.from(atob(str), c => c.charCodeAt(0))]).stream().pipeThrough(new DecompressionStream('gzip'));
            return await new Response(stream).text();
        } catch(e) { console.error(e); return ''; }
    }

    // Load from URL or LocalStorage
    async function initNotes() {
        const hash = window.location.hash.slice(1);
        if(hash) {
            noteInput.value = await decompress(hash);
            noteStatus.textContent = 'URL LOAD';
        } else {
            noteInput.value = localStorage.getItem('ink-notes') || "";
        }
        noteCount.textContent = noteInput.value.length + " chars";
    }
    initNotes();

    // Auto-Save
    let noteTimer;
    noteInput.addEventListener('input', () => {
        noteCount.textContent = noteInput.value.length + " chars";
        noteStatus.textContent = '...';
        
        clearTimeout(noteTimer);
        noteTimer = setTimeout(async () => {
            localStorage.setItem('ink-notes', noteInput.value);
            const compressed = await compress(noteInput.value);
            if(compressed) window.history.replaceState(null, null, '#' + compressed);
            
            noteStatus.textContent = 'SAVED';
            noteStatus.style.color = '#fff';
            setTimeout(() => { noteStatus.textContent = 'IDLE'; noteStatus.style.color = '#555'; }, 1000);
        }, 1000);
    });


    // --- 3. NEURAL TERMINAL (Left - WebLLM) ---
    const chatLog = document.getElementById('chat-log');
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');
    const aiDot = document.getElementById('ai-status-dot');
    
    let engine = null;
    const modelId = "Qwen2.5-0.5B-Instruct-q4f16_1-MLC"; // Fast, light model

    chatSend.addEventListener('click', handleChat);
    chatInput.addEventListener('keypress', (e) => {
        if(e.key === 'Enter') handleChat();
    });

    async function handleChat() {
        const txt = chatInput.value.trim();
        if(!txt) return;

        addLog('user', txt);
        chatInput.value = '';
        chatInput.disabled = true;
        chatSend.disabled = true;

        if(!engine) {
            addLog('sys', 'Initializing Neural Core (approx 300MB)...');
            try {
                const { CreateMLCEngine } = await import("https://esm.run/@mlc-ai/web-llm@0.2.79");
                engine = await CreateMLCEngine(modelId, {
                    initProgressCallback: (report) => {
                        if(report.progress === 1) {
                            addLog('sys', 'Core Online.');
                            aiDot.classList.add('active');
                        }
                    }
                });
            } catch(e) {
                addLog('sys', 'Init Failed: ' + e.message);
                resetChat();
                return;
            }
        }

        try {
            const chunks = await engine.chat.completions.create({
                messages: [
                    { role: "system", content: "You are a noir terminal assistant. Be concise." },
                    { role: "user", content: txt }
                ],
                temperature: 0.7,
                max_tokens: 256,
            });
            addLog('sys', chunks.choices[0].message.content);
        } catch(e) {
            addLog('sys', 'Error: ' + e.message);
        }

        resetChat();
    }

    function resetChat() {
        chatInput.disabled = false;
        chatSend.disabled = false;
        chatInput.focus();
    }

    function addLog(role, txt) {
        const div = document.createElement('div');
        div.className = `log-msg ${role}`;
        div.textContent = (role === 'user' ? '> ' : '') + txt;
        chatLog.appendChild(div);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

});
</script>
</body>
</html>
